<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Settings Modal</title>
    <style>
      :root {
        --bg: #0e0f12;
        --panel: #17191f;
        --panel2: #12141a;
        --line: #2a2f3a;
        --text: #e9eef7;
        --muted: #a9b3c7;
        --green: #35c16b;
        --red: #ff4d4d;
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
        --radius: 14px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0c0d11, #0e0f12);
        color: var(--text);
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial;
      }

      .page {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .btn {
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--text);
        border-radius: 12px;
        padding: 12px 16px;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .btn:hover {
        filter: brightness(1.06);
      }

      /* ===== Modal ===== */
      .backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .backdrop.open {
        display: flex;
      }

      .modal {
        width: min(980px, 100%);
        max-height: min(860px, 92vh);
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 18px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--line);
        background: linear-gradient(180deg, #1a1d25, #17191f);
      }
      .modal-header .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pill {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.03);
      }
      .icon-btn {
        border: 1px solid var(--line);
        background: transparent;
        color: var(--text);
        width: 36px;
        height: 36px;
        border-radius: 12px;
        cursor: pointer;
      }
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .tabbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        background: var(--panel2);
        gap: 10px;
      }
      .tab-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .mini-btn {
        border: 1px solid var(--line);
        background: transparent;
        color: var(--text);
        border-radius: 12px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .mini-btn:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .modal-body {
        padding: 12px;
        overflow: hidden;
        flex: 1;
        display: flex;
        gap: 12px;
      }

      .side {
        width: 260px;
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .content {
        flex: 1;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--line);
        border-radius: 16px;
        overflow: auto;
        padding: 14px;
      }

      .section {
        border: 1px solid var(--line);
        background: var(--panel2);
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 14px;
      }
      .section-title {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .section-title h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.02em;
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
      }

      .badge {
        font-size: 11px;
        color: var(--muted);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.03);
      }

      .text-input {
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        outline: none;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.08);
        margin: 10px 0;
      }

      .switch {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .switch input {
        display: none;
      }
      .toggle {
        width: 46px;
        height: 26px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        position: relative;
        cursor: pointer;
        flex: 0 0 auto;
      }
      .toggle::after {
        content: "";
        width: 20px;
        height: 20px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.85);
        position: absolute;
        top: 50%;
        left: 3px;
        transform: translateY(-50%);
        transition: all 0.18s ease;
      }
      .switch input:checked + .toggle {
        background: rgba(53, 193, 107, 0.25);
        border-color: rgba(53, 193, 107, 0.45);
      }
      .switch input:checked + .toggle::after {
        left: 23px;
        background: rgba(53, 193, 107, 0.95);
      }

      .card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.18);
        border-radius: 14px;
        padding: 12px;
      }

      .user-card-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .user-name {
        font-size: 13px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .danger {
        border-color: rgba(255, 77, 77, 0.35) !important;
        color: #ffdada;
      }
      .danger:hover {
        background: rgba(255, 77, 77, 0.08) !important;
      }

      .checks {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px 10px;
      }
      @media (max-width: 860px) {
        .modal-body {
          flex-direction: column;
        }
        .side {
          width: 100%;
        }
        .checks {
          grid-template-columns: 1fr;
        }
      }
      .check {
        display: flex;
        gap: 10px;
        align-items: center;
        color: var(--muted);
        font-size: 12px;
      }
      .check input {
        width: 16px;
        height: 16px;
      }

      .radio-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .radio {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.18);
        border-radius: 12px;
        padding: 8px 10px;
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 12px;
      }
      .radio input {
        accent-color: #8fb3ff;
      }
      .radio.active {
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
      }

      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .mono {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <button class="btn" id="openBtn">設定を開く</button>
    </div>

    <div class="backdrop" id="backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="modal-header">
          <div class="left">
            <div class="pill">Settings</div>
            <span class="badge" id="summaryBadge">0 users</span>
          </div>
          <button class="icon-btn" id="closeBtn" aria-label="Close">×</button>
        </div>

        <div class="tabbar">
          <div class="tab-actions">
            <button class="mini-btn" id="btnSave">Save</button>
            <button class="mini-btn" id="btnLoad">Load</button>
            <button class="mini-btn danger" id="btnReset">Reset</button>
          </div>
        </div>

        <div class="modal-body">
          <!-- left -->
          <div class="side">
            <div class="section">
              <div class="section-title">
                <h3>ユーザー追加</h3>
                <span class="hint">AniListのユーザー名</span>
              </div>
              <div class="row">
                <input
                  class="text-input"
                  id="inpUser"
                  placeholder="例: yuhei_kashima"
                  autocomplete="off"
                />
                <button class="mini-btn" id="btnAddUser">Add</button>
              </div>
              <div class="divider"></div>
              <div class="small">
                ※ ここでは見た目と設定の保持まで。<br />
                実際のリスト取得は別で GraphQL 呼び出しを繋ぐ想定。
              </div>
            </div>

            <div class="section">
              <div class="section-title">
                <h3>出題集合</h3>
                <span class="hint">AND / OR</span>
              </div>

              <div class="radio-row" id="setModeRow">
                <label class="radio" data-mode="or">
                  <input type="radio" name="setMode" value="or" />
                  OR（誰かのリスト）
                </label>
                <label class="radio" data-mode="and">
                  <input type="radio" name="setMode" value="and" />
                  AND（全員に含まれる）
                </label>
              </div>

              <div class="divider"></div>
              <div class="small" id="setModeHint"></div>
            </div>
          </div>

          <!-- right -->
          <div class="content">
            <div class="section">
              <div class="section-title">
                <h3>登録ユーザー</h3>
                <span class="hint">ユーザーごとに対象ステータスを選択</span>
              </div>

              <div id="usersRoot"></div>

              <div class="small" id="emptyHint" style="display: none">
                まだユーザーがありません。左から追加してください。
              </div>
            </div>

            <div class="section">
              <div class="section-title">
                <h3>現在の設定（デバッグ表示）</h3>
                <span class="hint">JSON</span>
              </div>
              <pre
                class="card mono"
                id="debugJson"
                style="white-space: pre-wrap; margin: 0"
              ></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const el = (id) => document.getElementById(id);

      // ====== Data model ======
      // statuses: AniList MediaListStatus
      const STATUS_LIST = [
        { key: "CURRENT", label: "Watching (CURRENT)" },
        { key: "PLANNING", label: "Plan to watch (PLANNING)" },
        { key: "COMPLETED", label: "Completed (COMPLETED)" },
        { key: "PAUSED", label: "Paused (PAUSED)" },
        { key: "DROPPED", label: "Dropped (DROPPED)" },
        { key: "REPEATING", label: "Rewatching (REPEATING)" },
      ];

      const DEFAULT_USER_STATUSES = () =>
        new Set(["CURRENT", "PLANNING", "COMPLETED"]);

      const STORAGE_KEY = "anidle_settings_v1";

      const state = {
        setMode: "or", // "or" | "and"
        users: [
          // { id, name, statuses:Set }
        ],
      };

      // ====== Modal open/close ======
      const backdrop = el("backdrop");
      el("openBtn").addEventListener("click", () => {
        backdrop.classList.add("open");
        backdrop.setAttribute("aria-hidden", "false");
        render();
      });
      const close = () => {
        backdrop.classList.remove("open");
        backdrop.setAttribute("aria-hidden", "true");
      };
      el("closeBtn").addEventListener("click", close);
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) close();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });

      // ====== Helpers ======
      const uid = () =>
        Math.random().toString(16).slice(2) + Date.now().toString(16);

      function normalizeUserName(s) {
        return (s ?? "").trim();
      }

      function userExists(name) {
        const n = name.toLowerCase();
        return state.users.some((u) => u.name.toLowerCase() === n);
      }

      function setModeText(mode) {
        if (mode === "and") {
          if (state.users.length < 2)
            return "AND は2人以上いるときに意味が出ます（1人なら OR と同じ結果）。";
          return "全ユーザーの対象ステータスに “共通して含まれる作品” のみ出題します（難しめ）。";
        }
        return "どれか1人でも対象ステータスに含まれていれば出題します（母数多め）。";
      }

      function setMode(mode) {
        state.setMode = mode;
        render();
      }

      function addUser(name) {
        const n = normalizeUserName(name);
        if (!n) return;
        if (userExists(n)) return;

        state.users.push({
          id: uid(),
          name: n,
          statuses: DEFAULT_USER_STATUSES(),
        });
        el("inpUser").value = "";
        render();
      }

      function removeUser(id) {
        state.users = state.users.filter((u) => u.id !== id);
        render();
      }

      function toggleUserStatus(userId, statusKey, checked) {
        const u = state.users.find((x) => x.id === userId);
        if (!u) return;

        if (checked) u.statuses.add(statusKey);
        else u.statuses.delete(statusKey);

        renderDebug();
      }

      // ====== Persistence ======
      function serialize() {
        return {
          setMode: state.setMode,
          users: state.users.map((u) => ({
            id: u.id,
            name: u.name,
            statuses: Array.from(u.statuses),
          })),
        };
      }

      function applySerialized(obj) {
        if (!obj || typeof obj !== "object") return;

        const setModeVal = obj.setMode === "and" ? "and" : "or";
        const users = Array.isArray(obj.users) ? obj.users : [];

        state.setMode = setModeVal;
        state.users = users
          .filter((u) => u && typeof u.name === "string")
          .map((u) => ({
            id: typeof u.id === "string" ? u.id : uid(),
            name: normalizeUserName(u.name),
            statuses: new Set(
              Array.isArray(u.statuses)
                ? u.statuses.filter((s) => STATUS_LIST.some((x) => x.key === s))
                : Array.from(DEFAULT_USER_STATUSES()),
            ),
          }))
          .filter((u) => u.name.length > 0);

        // unique by name (case-insensitive)
        const seen = new Set();
        state.users = state.users.filter((u) => {
          const k = u.name.toLowerCase();
          if (seen.has(k)) return false;
          seen.add(k);
          return true;
        });

        render();
      }

      function saveToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(serialize()));
      }

      function loadFromStorage() {
        const s = localStorage.getItem(STORAGE_KEY);
        if (!s) return false;
        try {
          applySerialized(JSON.parse(s));
          return true;
        } catch {
          return false;
        }
      }

      // ====== UI render ======
      function renderUsers() {
        const root = el("usersRoot");
        root.innerHTML = "";

        el("emptyHint").style.display = state.users.length ? "none" : "block";

        state.users.forEach((u) => {
          const card = document.createElement("div");
          card.className = "card";
          card.style.marginBottom = "12px";

          const head = document.createElement("div");
          head.className = "user-card-head";

          const name = document.createElement("div");
          name.className = "user-name";
          name.innerHTML = `<strong>${escapeHtml(u.name)}</strong><span class="badge">${u.statuses.size} statuses</span>`;

          const actions = document.createElement("div");
          actions.className = "row";
          actions.style.justifyContent = "flex-end";

          const btnDel = document.createElement("button");
          btnDel.className = "mini-btn danger";
          btnDel.textContent = "Remove";
          btnDel.addEventListener("click", () => removeUser(u.id));

          actions.appendChild(btnDel);
          head.appendChild(name);
          head.appendChild(actions);

          const checks = document.createElement("div");
          checks.className = "checks";

          STATUS_LIST.forEach((st) => {
            const wrap = document.createElement("label");
            wrap.className = "check";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = u.statuses.has(st.key);
            cb.addEventListener("change", () =>
              toggleUserStatus(u.id, st.key, cb.checked),
            );

            const text = document.createElement("span");
            text.textContent = st.label;

            wrap.appendChild(cb);
            wrap.appendChild(text);
            checks.appendChild(wrap);
          });

          card.appendChild(head);
          card.appendChild(checks);
          root.appendChild(card);
        });
      }

      function renderSetMode() {
        const row = el("setModeRow");
        const radios = row.querySelectorAll('input[name="setMode"]');
        radios.forEach((r) => (r.checked = r.value === state.setMode));

        row.querySelectorAll(".radio").forEach((label) => {
          const mode = label.getAttribute("data-mode");
          label.classList.toggle("active", mode === state.setMode);
        });

        el("setModeHint").textContent = setModeText(state.setMode);
      }

      function renderSummary() {
        el("summaryBadge").textContent = `${state.users.length} users`;
      }

      function renderDebug() {
        el("debugJson").textContent = JSON.stringify(serialize(), null, 2);
      }

      function render() {
        renderUsers();
        renderSetMode();
        renderSummary();
        renderDebug();
      }

      // ====== Events ======
      el("btnAddUser").addEventListener("click", () =>
        addUser(el("inpUser").value),
      );
      el("inpUser").addEventListener("keydown", (e) => {
        if (e.key === "Enter") addUser(el("inpUser").value);
      });

      el("setModeRow").addEventListener("click", (e) => {
        const label = e.target.closest(".radio");
        if (!label) return;
        const mode = label.getAttribute("data-mode");
        if (mode === "and" || mode === "or") setMode(mode);
      });

      el("btnSave").addEventListener("click", () => {
        saveToStorage();
        alert("Saved (localStorage)");
      });
      el("btnLoad").addEventListener("click", () => {
        const ok = loadFromStorage();
        alert(ok ? "Loaded" : "No saved data");
      });
      el("btnReset").addEventListener("click", () => {
        if (!confirm("設定を初期化します。よろしいですか？")) return;
        state.setMode = "or";
        state.users = [];
        saveToStorage();
        render();
      });

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // init: try load, else start empty
      loadFromStorage();
    </script>
  </body>
</html>
