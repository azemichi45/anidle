<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anidle</title>
    <link rel="stylesheet" href="./styles/common.css" />
    <link rel="stylesheet" href="./styles/game.css" />
  </head>
  <body>
    <div class="wrap">
      <h1>Anidle</h1>

      <div id="topPanel" class="top">
        <div class="row">
          <div id="inputArea" class="searchBox">
            <input
              id="searchInput"
              type="text"
              placeholder="Type anime title (English / Romaji)..."
              autocomplete="off"
              disabled
            />
            <div id="suggestBox" class="suggest"></div>
          </div>

          <button id="guessBtn" disabled>Guess</button>
          <button id="giveUpBtn" disabled class="btnGhost">Give Up</button>
          <div id="status" class="status">Press â€œGame Startâ€.</div>
        </div>

        <div class="legend">
          <span class="chip"><span class="ok">GREEN</span> = match</span>
          <span class="chip"><span class="ng">RED</span> = not match</span>
          <span class="chip"
            >Year/Score: â†‘â†“ indicates higher/lower than answer</span
          >
          <span class="chip"
            >Genres/Themes: each item individually colored</span
          >
        </div>
      </div>

      <!-- â˜… Clear Screenï¼ˆæœ€åˆã¯display:noneï¼‰ -->
      <section id="clearScreen" class="clearScreen" aria-label="Clear screen">
        <div class="clearInner">
          <div class="clearImg">
            <img id="clearCover" alt="Cover" />
          </div>
          <div id="clearTitle" class="clearTitle">-</div>
          <div class="clearBtns">
            <button id="playAgainBtn" class="btnPrimary">Play Again</button>
            <button id="backToTitleBtn" class="btnGhost">Back to Title</button>
          </div>
        </div>
      </section>

      <div id="gameResult"></div>

      <div id="tableWrap" class="tableWrap" style="margin-top: 14px">
        <table aria-label="Anidle answers">
          <thead>
            <tr>
              <th>Title</th>
              <th class="center">Year</th>
              <th class="center">Genres</th>
              <th class="center">Themes</th>
              <th class="center">Studio</th>
              <th class="center">Source</th>
              <th class="center">Score</th>
            </tr>
          </thead>
          <tbody id="answersBody"></tbody>
        </table>
      </div>
    </div>

    <script src="./getAnswerAnimeId.js"></script>
    <script>
      // ============================
      // AniList GraphQL (Guessç”¨ã¯ãã®ã¾ã¾)
      // ============================
      const ANILIST_URL = "https://graphql.anilist.co";

      async function anilist(query, variables) {
        const res = await fetch(ANILIST_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify({ query, variables }),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`AniList HTTP ${res.status}: ${text}`);
        }
        const json = await res.json();
        if (json.errors?.length) {
          throw new Error(json.errors.map((e) => e.message).join(" / "));
        }
        return json.data;
      }

      // ============================
      // Queriesï¼ˆSEARCHã¯ä½¿ã‚ãªã„ï¼šãƒ­ãƒ¼ã‚«ãƒ«JSONã§ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼‰
      // ============================
      const Q_DETAIL = `
        query($id:Int){
          Media(id:$id, type:ANIME){
            id
            title{ romaji english }
            startDate{ year }
            genres
            tags{ name rank isMediaSpoiler isGeneralSpoiler }
            studios(isMain:true){
              nodes{ name }
            }
            source
            averageScore
            coverImage { large }
          }
        }
      `;

      // ============================
      // Utils
      // ============================
      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFKD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9\s]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function fmtSource(src) {
        if (!src) return "";
        return src
          .toLowerCase()
          .replace(/_/g, " ")
          .replace(/\b\w/g, (c) => c.toUpperCase());
      }

      function pickMainStudio(studios) {
        const name = studios?.nodes?.[0]?.name;
        return name || "";
      }

      function extractThemes(tags) {
        return (tags || [])
          .filter((t) => !t.isMediaSpoiler && !t.isGeneralSpoiler)
          .sort((a, b) => (b.rank || 0) - (a.rank || 0))
          .slice(0, 6)
          .map((t) => t.name);
      }

      function arrowIcon(dir /* 'up' | 'down' */) {
        if (dir === "up") {
          return `
            <span class="arrow" title="Higher than answer">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M5.71 9.7c.39.39 1.02.39 1.41 0L11 5.83V21c0 .55.45 1 1 1s1-.45 1-1V5.83l3.88 3.88c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L12.7 2.7a.9959.9959 0 0 0-1.41 0L5.71 8.29c-.39.39-.39 1.03 0 1.41z"></path>
              </svg>
            </span>`;
        }
        return `
          <span class="arrow" title="Lower than answer">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M18.3 14.29a.9959.9959 0 0 0-1.41 0L13 18.17V3c0-.55-.45-1-1-1s-1 .45-1 1v15.18L7.12 14.3a.9959.9959 0 0 0-1.41 0c-.39.39-.39 1.02 0 1.41l5.59 5.59c.39.39 1.02.39 1.41 0l5.59-5.59c.38-.39.38-1.03 0-1.42z"></path>
              </svg>
          </span>`;
      }

      function colorClass(ok) {
        return ok ? "ok" : "ng";
      }

      function makeLinesCell(items, answerSet) {
        const div = document.createElement("div");
        div.className = "cellLines";
        if (!items?.length) {
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "-";
          div.appendChild(p);
          return div;
        }
        items.forEach((x) => {
          const p = document.createElement("div");
          p.className = colorClass(answerSet.has(x));
          p.textContent = x;
          div.appendChild(p);
        });
        return div;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function setWarnStatus(msg) {
        statusEl.textContent = msg;
        statusEl.classList.add("warn", "shake");

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¯å›åŠ¹ã‹ã›ã‚‹ãŸã‚
        setTimeout(() => {
          statusEl.classList.remove("shake");
        }, 400);
      }
      // ============================
      // Suggest: JSONã‚’fetchã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«æ¤œç´¢ï¼ˆé«˜é€ŸåŒ–ï¼‰
      // ============================
      const SUGGEST_JSON_URL = "./data/anilist_anime_id_titles.json";

      let animeIndex = []; // {id, romaji, english, nRomaji, nEnglish}
      let animeLoaded = false;
      let animeLoadPromise = null;

      async function loadAnimeJsonOnce() {
        if (animeLoaded) return;
        if (animeLoadPromise) return animeLoadPromise;

        animeLoadPromise = (async () => {
          const res = await fetch(SUGGEST_JSON_URL, { cache: "force-cache" });
          if (!res.ok)
            throw new Error(
              `Failed to load ${SUGGEST_JSON_URL} (${res.status})`,
            );
          const arr = await res.json();

          animeIndex = (arr || [])
            .filter((x) => x && typeof x.id !== "undefined")
            .map((x) => {
              const romaji = (x.romaji || "").trim();
              const english = (x.english || "").trim();
              return {
                id: Number(x.id),
                romaji,
                english,
                nRomaji: norm(romaji),
                nEnglish: norm(english),
              };
            });

          animeLoaded = true;
        })();

        return animeLoadPromise;
      }

      // prefixå„ªå…ˆ â†’ ãªã‘ã‚Œã°contains
      function rankSuggestLocal(q) {
        const nq = norm(q);
        if (!nq) return [];

        const prefix = [];
        const contains = [];

        for (const it of animeIndex) {
          if (it.nEnglish) {
            if (it.nEnglish.startsWith(nq)) {
              prefix.push({
                id: it.id,
                kind: "english",
                text: it.english,
                len: it.nEnglish.length,
              });
            } else if (it.nEnglish.includes(nq)) {
              contains.push({
                id: it.id,
                kind: "english",
                text: it.english,
                len: it.nEnglish.length,
              });
            }
          }
          if (it.nRomaji) {
            if (it.nRomaji.startsWith(nq)) {
              prefix.push({
                id: it.id,
                kind: "romaji",
                text: it.romaji,
                len: it.nRomaji.length,
              });
            } else if (it.nRomaji.includes(nq)) {
              contains.push({
                id: it.id,
                kind: "romaji",
                text: it.romaji,
                len: it.nRomaji.length,
              });
            }
          }
        }

        function sortKey(a, b) {
          return a.len - b.len || a.text.localeCompare(b.text);
        }
        prefix.sort(sortKey);
        contains.sort(sortKey);

        const out = [];
        const seen = new Set();
        for (const x of [...prefix, ...contains]) {
          const k = x.id + "|" + norm(x.text);
          if (seen.has(k)) continue;
          seen.add(k);
          out.push(x);
          if (out.length >= 20) break;
        }
        return out;
      }

      // ============================
      // Game state
      // ============================
      let answer = null; // full detail object
      let selected = null; // { id, displayText }
      let started = false;
      let guessedIds = new Set();
      let isGuessing = false;
      // ============================
      // DOM
      // ============================
      const topPanel = document.getElementById("topPanel");
      const inputArea = document.getElementById("inputArea");
      const searchInput = document.getElementById("searchInput");
      const suggestBox = document.getElementById("suggestBox");
      const guessBtn = document.getElementById("guessBtn");
      const statusEl = document.getElementById("status");
      const answersBody = document.getElementById("answersBody");
      const tableWrap = document.getElementById("tableWrap");
      const giveUpBtn = document.getElementById("giveUpBtn");
      // Clear screen DOM
      const clearScreen = document.getElementById("clearScreen");
      const clearCover = document.getElementById("clearCover");
      const clearTitle = document.getElementById("clearTitle");
      const playAgainBtn = document.getElementById("playAgainBtn");
      const backToTitleBtn = document.getElementById("backToTitleBtn");

      let activeIndex = -1;
      let lastRanked = [];

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      function closeSuggest() {
        suggestBox.classList.remove("show");
        suggestBox.innerHTML = "";
        activeIndex = -1;
        lastRanked = [];
      }

      function openSuggest() {
        if (suggestBox.children.length) suggestBox.classList.add("show");
      }

      function setActive(index) {
        const items = Array.from(suggestBox.querySelectorAll(".sitem"));
        if (!items.length) {
          activeIndex = -1;
          return;
        }
        activeIndex = Math.max(0, Math.min(index, items.length - 1));
        items.forEach((el, i) =>
          el.classList.toggle("active", i === activeIndex),
        );
        items[activeIndex].scrollIntoView({ block: "nearest" });
      }

      function chooseActive() {
        if (activeIndex < 0 || activeIndex >= lastRanked.length) return false;
        const s = lastRanked[activeIndex];
        selected = { id: s.id, displayText: s.text };
        searchInput.value = s.text;
        closeSuggest();
        return true;
      }

      // ============================
      // Clear Screen helpers
      // ============================
      function showClearScreen(a) {
        // â˜… topPanel ã‚’ä¸¸ã”ã¨æ¶ˆã™
        topPanel.classList.add("hidden");

        closeSuggest();

        const title = a?.title?.english || a?.title?.romaji || "(no title)";
        clearTitle.textContent = title;
        clearCover.src = a?.img || "";
        clearCover.alt = title;

        clearScreen.classList.add("show");
      }

      function hideClearScreen() {
        clearScreen.classList.remove("show");
        clearCover.removeAttribute("src");
        clearTitle.textContent = "-";

        // â˜… topPanel ã‚’æˆ»ã™
        topPanel.classList.remove("hidden");
      }

      // ============================
      // Suggest rendering (local json)
      // ============================
      function renderSuggest(ranked) {
        lastRanked = ranked;
        suggestBox.innerHTML = "";

        for (let i = 0; i < ranked.length; i++) {
          const s = ranked[i];
          const div = document.createElement("div");
          div.className = "sitem";
          div.dataset.index = String(i);

          div.innerHTML = `
            <div class="stitle">${escapeHtml(s.text)}</div>
            <div class="ssub">${s.kind === "english" ? "English" : "Romaji"} â€¢ ID:${s.id}</div>
          `;

          div.addEventListener("mouseenter", () => setActive(i));

          div.addEventListener("mousedown", (e) => {
            e.preventDefault();
            selected = { id: s.id, displayText: s.text };
            searchInput.value = s.text;
            closeSuggest();
            syncGuessBtn();
          });

          suggestBox.appendChild(div);
        }

        if (ranked.length) {
          suggestBox.classList.add("show");
          activeIndex = 0;
          setActive(0);
        } else {
          closeSuggest();
        }
      }

      let debounceTimer = null;
      async function onType() {
        const q = searchInput.value.trim();
        selected = null;

        if (!q) {
          closeSuggest();
          syncGuessBtn();
          return;
        }

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          try {
            await loadAnimeJsonOnce();
            const ranked = rankSuggestLocal(q);
            renderSuggest(ranked);
            syncGuessBtn();
          } catch (e) {
            console.error(e);
            closeSuggest();
            syncGuessBtn();
          }
        }, 60);
      }

      // ============================
      // Start game (random answer)
      // ============================
      async function startGame() {
        try {
          // â˜… ã‚¯ãƒªã‚¢ç”»é¢ã‚’ç¢ºå®Ÿã«éš ã™ï¼ˆã€Œé–‹å§‹æ™‚ã‹ã‚‰è¦‹ãˆã‚‹ã€å¯¾ç­–ï¼‰
          hideClearScreen();

          guessBtn.disabled = true;
          searchInput.disabled = true;
          answersBody.innerHTML = "";
          guessedIds = new Set();
          selected = null;
          answer = null;
          started = false;

          setStatus("Loading random anime...");

          // ã‚µã‚¸ã‚§ã‚¹ãƒˆJSONã¯ã“ã“ã§å…ˆèª­ã¿
          await loadAnimeJsonOnce();

          // è¨­å®šã‹ã‚‰ç­”ãˆIDå–å¾—ï¼ˆå¤–éƒ¨jsï¼‰
          const pickedAnimeId = await getRandomAnswerAnimeIdFromLocalStorage();

          const detail = await anilist(Q_DETAIL, { id: pickedAnimeId });
          answer = normalizeDetail(detail.Media);
          console.log("ANSWER:", answer);

          started = true;
          searchInput.disabled = false;
          selected = null;
          searchInput.value = "";
          guessBtn.disabled = true;
          giveUpBtn.disabled = false;
          setStatus("Ready. Type a title and guess!");
          searchInput.focus();
        } catch (e) {
          console.error(e);
          setStatus("Failed to start: " + e.message);
        }
      }

      function normalizeDetail(m) {
        return {
          id: m.id,
          title: {
            english: (m.title?.english || "").trim(),
            romaji: (m.title?.romaji || "").trim(),
          },
          year: m.startDate?.year ?? null,
          genres: (m.genres || []).filter(Boolean),
          themes: extractThemes(m.tags || []),
          studio: pickMainStudio(m.studios),
          source: fmtSource(m.source),
          score: m.averageScore ?? null,
          score10: m.averageScore != null ? m.averageScore / 10 : null,
          img: m.coverImage?.large || "",
        };
      }

      // ============================
      // Guess
      // ============================
      async function doGuess() {
        if (isGuessing) return;
        if (!started || !answer) return;
        if (!selected?.id) return;
        isGuessing = true;

        const sid = Number(selected.id);
        if (guessedIds.has(sid)) {
          setWarnStatus("Already guessed that title!");

          searchInput.value = "";
          selected = null;
          closeSuggest();
          syncGuessBtn();
          searchInput.focus();
          return;
        }
        try {
          guessBtn.disabled = true;
          setStatus("Checking...");

          const detail = await anilist(Q_DETAIL, { id: selected.id });
          const g = normalizeDetail(detail.Media);
          appendRow(g, answer);
          guessedIds.add(g.id);
          if (g.id === answer.id) {
            setStatus("Correct! ğŸ‰");
            searchInput.disabled = true;
            giveUpBtn.disabled = true;
            closeSuggest();

            // â˜… ã“ã“ã§ã‚¯ãƒªã‚¢ç”»é¢ã‚’è¡¨ç¤º
            showClearScreen(answer);
          } else {
            setStatus("Not yet. Try again.");
            selected = null;
            searchInput.value = "";
            searchInput.focus();
          }
        } catch (e) {
          console.error(e);
          setStatus("Failed: " + e.message);
        } finally {
          isGuessing = false;
          syncGuessBtn();
        }
      }

      function giveUp() {
        if (!started || !answer) return;

        setStatus("Gave upâ€¦ ğŸ˜¢");

        // å…¥åŠ›ä¸èƒ½ã«
        started = false;
        searchInput.disabled = true;
        guessBtn.disabled = true;
        giveUpBtn.disabled = true;
        closeSuggest();

        // â˜… æ­£è§£ã§ã¯ãªã„ãŒã€ç­”ãˆã‚’å…¬é–‹ã—ã¦ã‚¯ãƒªã‚¢ç”»é¢ã¸
        showClearScreen(answer);
      }
      function appendRow(g, a) {
        const tr = document.createElement("tr");

        const gTitle = g.title.english || g.title.romaji || "(no title)";
        const titleOk = g.id === a.id;

        const yearOk = g.year != null && a.year != null && g.year === a.year;
        const yearDir =
          !yearOk && g.year != null && a.year != null
            ? g.year < a.year
              ? "up"
              : "down"
            : null;

        const gs = g.score10;
        const as = a.score10;
        const scoreOk = gs != null && as != null && Math.abs(gs - as) < 1e-9;
        const scoreDir =
          !scoreOk && gs != null && as != null
            ? gs < as
              ? "up"
              : "down"
            : null;

        const studioOk =
          norm(g.studio) && norm(a.studio) && norm(g.studio) === norm(a.studio);
        const sourceOk =
          norm(g.source) && norm(a.source) && norm(g.source) === norm(a.source);

        const aGenres = new Set(a.genres);
        const aThemes = new Set(a.themes);

        const thTitle = document.createElement("th");
        thTitle.innerHTML = `<div class="${colorClass(titleOk)}" style="font-size:22px;font-weight:800;line-height:1.2">${escapeHtml(gTitle)}</div>`;
        tr.appendChild(thTitle);

        const tdYear = document.createElement("td");
        tdYear.className = "center";
        tdYear.innerHTML = `<div class="${colorClass(yearOk)}" style="font-size:22px;font-weight:800">
          ${g.year ?? "-"}${yearDir ? arrowIcon(yearDir) : ""}
        </div>`;
        tr.appendChild(tdYear);

        const tdGenres = document.createElement("td");
        tdGenres.className = "center";
        tdGenres.appendChild(makeLinesCell(g.genres, aGenres));
        tr.appendChild(tdGenres);

        const tdThemes = document.createElement("td");
        tdThemes.className = "center";
        tdThemes.appendChild(makeLinesCell(g.themes, aThemes));
        tr.appendChild(tdThemes);

        const tdStudio = document.createElement("td");
        tdStudio.className = "center";
        tdStudio.innerHTML = `<div class="${colorClass(studioOk)}" style="font-size:20px;font-weight:800">${escapeHtml(g.studio || "-")}</div>`;
        tr.appendChild(tdStudio);

        const tdSource = document.createElement("td");
        tdSource.className = "center";
        tdSource.innerHTML = `<div class="${colorClass(sourceOk)}" style="font-size:20px;font-weight:800">${escapeHtml(g.source || "-")}</div>`;
        tr.appendChild(tdSource);

        const tdScore = document.createElement("td");
        tdScore.className = "center";
        tdScore.innerHTML = `<div class="${colorClass(scoreOk)}" style="font-size:22px;font-weight:800">
          ${gs != null ? gs.toFixed(2) : "-"}${scoreDir ? arrowIcon(scoreDir) : ""}
        </div>`;
        tr.appendChild(tdScore);

        answersBody.prepend(tr);
      }

      // ============================
      // Events
      // ============================
      searchInput.addEventListener("input", onType);
      searchInput.addEventListener("focus", () => openSuggest());
      searchInput.addEventListener("blur", () => setTimeout(closeSuggest, 120));

      searchInput.addEventListener("keydown", (e) => {
        if (!started) return;

        const isOpen = suggestBox.classList.contains("show");
        const items = Array.from(suggestBox.querySelectorAll(".sitem"));

        if (isOpen && items.length) {
          if (e.key === "ArrowDown") {
            e.preventDefault();
            setActive(activeIndex + 1);
            return;
          }
          if (e.key === "ArrowUp") {
            e.preventDefault();
            setActive(activeIndex - 1);
            return;
          }
          if (e.key === "Enter") {
            e.preventDefault();
            chooseActive();
            syncGuessBtn();
            return;
          }
          if (e.key === "Escape") {
            e.preventDefault();
            closeSuggest();
            syncGuessBtn();
            return;
          }
        }

        if (e.key === "Enter") {
          e.preventDefault();
          if (selected?.id) doGuess();
        }
      });

      guessBtn.addEventListener("click", doGuess);

      giveUpBtn.addEventListener("click", giveUp);
      function syncGuessBtn() {
        guessBtn.disabled = !started || !selected?.id;
      }

      // Clear screen buttons
      playAgainBtn.addEventListener("click", () => {
        startGame(); // åŒãƒšãƒ¼ã‚¸ã§å†ã‚¹ã‚¿ãƒ¼ãƒˆ
      });

      backToTitleBtn.addEventListener("click", () => {
        window.location.href = "./index.html";
      });
      // ã‚¯ãƒªãƒƒã‚¯ä¿é™º
      document.addEventListener("click", () => syncGuessBtn());

      window.addEventListener("DOMContentLoaded", () => {
        // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        setStatus("Loading...");
        startGame();
      });

      // â˜… æ³¨æ„:
      // fetchã§ãƒ­ãƒ¼ã‚«ãƒ«JSONèª­ã‚€ã«ã¯ã€file:// ç›´é–‹ãã ã¨CORSç­‰ã§å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
      // `npx serve` / `python -m http.server` ãªã©ã§ http:// ã§é–‹ã„ã¦ãã ã•ã„ã€‚
    </script>
  </body>
</html>
