<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anidle</title>
    <style>
      :root {
        --bg: #0e0f12;
        --panel: #17191f;
        --panel2: #12141a;
        --line: #2a2f3a;
        --text: #e9eef7;
        --muted: #a9b3c7;
        --green: #35c16b;
        --red: #ff4d4d;
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
        --radius: 14px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        background: radial-gradient(
          1200px 700px at 50% -10%,
          #1a2030 0%,
          var(--bg) 55%
        );
        color: var(--text);
        padding: 24px;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        margin: 0 0 14px;
        font-size: 22px;
        letter-spacing: 0.2px;
      }
      .top {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        background: #2b3242;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text);
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }
      button:hover {
        filter: brightness(1.08);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .status {
        color: var(--muted);
        font-size: 13px;
        margin-left: auto;
        white-space: nowrap;
      }
      .status.warn {
        color: var(--red);
        font-weight: 700;
      }

      .status.shake {
        animation: shake 0.35s ease;
      }

      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        20% {
          transform: translateX(-4px);
        }
        40% {
          transform: translateX(4px);
        }
        60% {
          transform: translateX(-3px);
        }
        80% {
          transform: translateX(3px);
        }
        100% {
          transform: translateX(0);
        }
      }
      .searchBox {
        position: relative;
        flex: 1 1 380px;
        min-width: 260px;
      }
      input {
        width: 100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        outline: none;
        font-size: 14px;
      }
      input::placeholder {
        color: #7f8aa3;
      }
      .suggest {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 8px);
        background: #0f1218;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow);
        z-index: 20;
        display: none;
        max-height: 320px;
        overflow-y: auto;
      }
      .suggest.show {
        display: block;
      }
      .sitem {
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }
      .sitem:first-child {
        border-top: none;
      }
      .sitem:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .sitem.active {
        background: rgba(255, 255, 255, 0.08);
        outline: 1px solid rgba(255, 255, 255, 0.12);
      }
      .stitle {
        font-weight: 700;
      }
      .ssub {
        color: var(--muted);
        font-size: 12px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--muted);
        font-size: 12px;
        width: max-content;
      }

      .tableWrap {
        margin-top: 14px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.015)
        );
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      thead th {
        text-align: left;
        padding: 14px 14px;
        font-size: 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(0, 0, 0, 0.22);
        letter-spacing: 0.2px;
      }
      thead th.center,
      tbody td.center {
        text-align: center;
      }
      tbody tr {
        background: rgba(0, 0, 0, 0.12);
      }
      tbody tr + tr td,
      tbody tr + tr th {
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }
      tbody th,
      tbody td {
        vertical-align: middle;
        padding: 18px 14px;
      }
      .cellLines {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
        justify-content: center;
      }
      .ok {
        color: var(--green);
        font-weight: 700;
      }
      .ng {
        color: var(--red);
        font-weight: 700;
      }
      .muted {
        color: var(--muted);
      }
      .arrow {
        display: inline-flex;
        margin-left: 6px;
        vertical-align: middle;
        opacity: 0.9;
        transform: translateY(2px);
      }
      .arrow svg {
        width: 20px;
        height: 20px;
      }
      .legend {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 12px;
      }

      /* ============================
         Clear Screen
         ============================ */
      .clearScreen {
        display: none; /* ‚òÖÊúÄÂàù„ÅØÁµ∂ÂØæ„Å´Ë¶ã„Åõ„Å™„ÅÑ */
        margin-top: 14px;
        border-radius: var(--radius);
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.015)
        );
        box-shadow: var(--shadow);
        padding: 22px;
      }
      .clearScreen.show {
        display: block; /* ‚òÖ„ÇØ„É™„Ç¢ÊôÇ„Å†„Åë show „Çí‰ªò„Åë„Çã */
      }
      .clearInner {
        max-width: 720px;
        margin: 0 auto;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 14px;
        align-items: center;
      }
      .clearImg {
        width: min(520px, 92vw);
        aspect-ratio: 3 / 4;
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.25);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      }
      .clearImg img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .clearTitle {
        font-size: 26px;
        font-weight: 900;
        letter-spacing: 0.2px;
        line-height: 1.2;
      }
      .clearBtns {
        margin-top: 8px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btnPrimary {
        background: #2f3a55;
      }
      .btnGhost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }

      /* ÂÖ•ÂäõÊ¨Ñ„Çí‰∏∏„Åî„Å®Èö†„Åô„Åü„ÇÅ„ÅÆ„ÇØ„É©„Çπ */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Anidle</h1>

      <div id="topPanel" class="top">
        <div class="row">
          <div id="inputArea" class="searchBox">
            <input
              id="searchInput"
              type="text"
              placeholder="Type anime title (English / Romaji)..."
              autocomplete="off"
              disabled
            />
            <div id="suggestBox" class="suggest"></div>
          </div>

          <button id="guessBtn" disabled>Guess</button>
          <button id="giveUpBtn" disabled class="btnGhost">Give Up</button>
          <div id="status" class="status">Press ‚ÄúGame Start‚Äù.</div>
        </div>

        <div class="legend">
          <span class="chip"><span class="ok">GREEN</span> = match</span>
          <span class="chip"><span class="ng">RED</span> = not match</span>
          <span class="chip"
            >Year/Score: ‚Üë‚Üì indicates higher/lower than answer</span
          >
          <span class="chip"
            >Genres/Themes: each item individually colored</span
          >
        </div>
      </div>

      <!-- ‚òÖ Clear ScreenÔºàÊúÄÂàù„ÅØdisplay:noneÔºâ -->
      <section id="clearScreen" class="clearScreen" aria-label="Clear screen">
        <div class="clearInner">
          <div class="clearImg">
            <img id="clearCover" alt="Cover" />
          </div>
          <div id="clearTitle" class="clearTitle">-</div>
          <div class="clearBtns">
            <button id="playAgainBtn" class="btnPrimary">Play Again</button>
            <button id="backToTitleBtn" class="btnGhost">Back to Title</button>
          </div>
        </div>
      </section>

      <div id="gameResult"></div>

      <div id="tableWrap" class="tableWrap" style="margin-top: 14px">
        <table aria-label="Anidle answers">
          <thead>
            <tr>
              <th>Title</th>
              <th class="center">Year</th>
              <th class="center">Genres</th>
              <th class="center">Themes</th>
              <th class="center">Studio</th>
              <th class="center">Source</th>
              <th class="center">Score</th>
            </tr>
          </thead>
          <tbody id="answersBody"></tbody>
        </table>
      </div>
    </div>

    <script src="./getAnswerAnimeId.js"></script>
    <script>
      // ============================
      // AniList GraphQL (GuessÁî®„ÅØ„Åù„ÅÆ„Åæ„Åæ)
      // ============================
      const ANILIST_URL = "https://graphql.anilist.co";

      async function anilist(query, variables) {
        const res = await fetch(ANILIST_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify({ query, variables }),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`AniList HTTP ${res.status}: ${text}`);
        }
        const json = await res.json();
        if (json.errors?.length) {
          throw new Error(json.errors.map((e) => e.message).join(" / "));
        }
        return json.data;
      }

      // ============================
      // QueriesÔºàSEARCH„ÅØ‰Ωø„Çè„Å™„ÅÑÔºö„É≠„Éº„Ç´„É´JSON„Åß„Çµ„Ç∏„Çß„Çπ„ÉàÔºâ
      // ============================
      const Q_DETAIL = `
        query($id:Int){
          Media(id:$id, type:ANIME){
            id
            title{ romaji english }
            startDate{ year }
            genres
            tags{ name rank isMediaSpoiler isGeneralSpoiler }
            studios(isMain:true){
              nodes{ name }
            }
            source
            averageScore
            coverImage { large }
          }
        }
      `;

      // ============================
      // Utils
      // ============================
      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFKD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9\s]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function fmtSource(src) {
        if (!src) return "";
        return src
          .toLowerCase()
          .replace(/_/g, " ")
          .replace(/\b\w/g, (c) => c.toUpperCase());
      }

      function pickMainStudio(studios) {
        const name = studios?.nodes?.[0]?.name;
        return name || "";
      }

      function extractThemes(tags) {
        return (tags || [])
          .filter((t) => !t.isMediaSpoiler && !t.isGeneralSpoiler)
          .sort((a, b) => (b.rank || 0) - (a.rank || 0))
          .slice(0, 6)
          .map((t) => t.name);
      }

      function arrowIcon(dir /* 'up' | 'down' */) {
        if (dir === "up") {
          return `
            <span class="arrow" title="Higher than answer">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M5.71 9.7c.39.39 1.02.39 1.41 0L11 5.83V21c0 .55.45 1 1 1s1-.45 1-1V5.83l3.88 3.88c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L12.7 2.7a.9959.9959 0 0 0-1.41 0L5.71 8.29c-.39.39-.39 1.03 0 1.41z"></path>
              </svg>
            </span>`;
        }
        return `
          <span class="arrow" title="Lower than answer">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M18.3 14.29a.9959.9959 0 0 0-1.41 0L13 18.17V3c0-.55-.45-1-1-1s-1 .45-1 1v15.18L7.12 14.3a.9959.9959 0 0 0-1.41 0c-.39.39-.39 1.02 0 1.41l5.59 5.59c.39.39 1.02.39 1.41 0l5.59-5.59c.38-.39.38-1.03 0-1.42z"></path>
              </svg>
          </span>`;
      }

      function colorClass(ok) {
        return ok ? "ok" : "ng";
      }

      function makeLinesCell(items, answerSet) {
        const div = document.createElement("div");
        div.className = "cellLines";
        if (!items?.length) {
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "-";
          div.appendChild(p);
          return div;
        }
        items.forEach((x) => {
          const p = document.createElement("div");
          p.className = colorClass(answerSet.has(x));
          p.textContent = x;
          div.appendChild(p);
        });
        return div;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function setWarnStatus(msg) {
        statusEl.textContent = msg;
        statusEl.classList.add("warn", "shake");

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÊØéÂõûÂäπ„Åã„Åõ„Çã„Åü„ÇÅ
        setTimeout(() => {
          statusEl.classList.remove("shake");
        }, 400);
      }
      // ============================
      // Suggest: JSON„Çífetch„Åó„Å¶„É≠„Éº„Ç´„É´Ê§úÁ¥¢ÔºàÈ´òÈÄüÂåñÔºâ
      // ============================
      const SUGGEST_JSON_URL = "./data/anilist_anime_id_titles.json";

      let animeIndex = []; // {id, romaji, english, nRomaji, nEnglish}
      let animeLoaded = false;
      let animeLoadPromise = null;

      async function loadAnimeJsonOnce() {
        if (animeLoaded) return;
        if (animeLoadPromise) return animeLoadPromise;

        animeLoadPromise = (async () => {
          const res = await fetch(SUGGEST_JSON_URL, { cache: "force-cache" });
          if (!res.ok)
            throw new Error(
              `Failed to load ${SUGGEST_JSON_URL} (${res.status})`,
            );
          const arr = await res.json();

          animeIndex = (arr || [])
            .filter((x) => x && typeof x.id !== "undefined")
            .map((x) => {
              const romaji = (x.romaji || "").trim();
              const english = (x.english || "").trim();
              return {
                id: Number(x.id),
                romaji,
                english,
                nRomaji: norm(romaji),
                nEnglish: norm(english),
              };
            });

          animeLoaded = true;
        })();

        return animeLoadPromise;
      }

      // prefixÂÑ™ÂÖà ‚Üí „Å™„Åë„Çå„Å∞contains
      function rankSuggestLocal(q) {
        const nq = norm(q);
        if (!nq) return [];

        const prefix = [];
        const contains = [];

        for (const it of animeIndex) {
          if (it.nEnglish) {
            if (it.nEnglish.startsWith(nq)) {
              prefix.push({
                id: it.id,
                kind: "english",
                text: it.english,
                len: it.nEnglish.length,
              });
            } else if (it.nEnglish.includes(nq)) {
              contains.push({
                id: it.id,
                kind: "english",
                text: it.english,
                len: it.nEnglish.length,
              });
            }
          }
          if (it.nRomaji) {
            if (it.nRomaji.startsWith(nq)) {
              prefix.push({
                id: it.id,
                kind: "romaji",
                text: it.romaji,
                len: it.nRomaji.length,
              });
            } else if (it.nRomaji.includes(nq)) {
              contains.push({
                id: it.id,
                kind: "romaji",
                text: it.romaji,
                len: it.nRomaji.length,
              });
            }
          }
        }

        function sortKey(a, b) {
          return a.len - b.len || a.text.localeCompare(b.text);
        }
        prefix.sort(sortKey);
        contains.sort(sortKey);

        const out = [];
        const seen = new Set();
        for (const x of [...prefix, ...contains]) {
          const k = x.id + "|" + norm(x.text);
          if (seen.has(k)) continue;
          seen.add(k);
          out.push(x);
          if (out.length >= 20) break;
        }
        return out;
      }

      // ============================
      // Game state
      // ============================
      let answer = null; // full detail object
      let selected = null; // { id, displayText }
      let started = false;
      let guessedIds = new Set();
      // ============================
      // DOM
      // ============================
      const topPanel = document.getElementById("topPanel");
      const inputArea = document.getElementById("inputArea");
      const searchInput = document.getElementById("searchInput");
      const suggestBox = document.getElementById("suggestBox");
      const guessBtn = document.getElementById("guessBtn");
      const statusEl = document.getElementById("status");
      const answersBody = document.getElementById("answersBody");
      const tableWrap = document.getElementById("tableWrap");
      const giveUpBtn = document.getElementById("giveUpBtn");
      // Clear screen DOM
      const clearScreen = document.getElementById("clearScreen");
      const clearCover = document.getElementById("clearCover");
      const clearTitle = document.getElementById("clearTitle");
      const playAgainBtn = document.getElementById("playAgainBtn");
      const backToTitleBtn = document.getElementById("backToTitleBtn");

      let activeIndex = -1;
      let lastRanked = [];

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      function closeSuggest() {
        suggestBox.classList.remove("show");
        suggestBox.innerHTML = "";
        activeIndex = -1;
        lastRanked = [];
      }

      function openSuggest() {
        if (suggestBox.children.length) suggestBox.classList.add("show");
      }

      function setActive(index) {
        const items = Array.from(suggestBox.querySelectorAll(".sitem"));
        if (!items.length) {
          activeIndex = -1;
          return;
        }
        activeIndex = Math.max(0, Math.min(index, items.length - 1));
        items.forEach((el, i) =>
          el.classList.toggle("active", i === activeIndex),
        );
        items[activeIndex].scrollIntoView({ block: "nearest" });
      }

      function chooseActive() {
        if (activeIndex < 0 || activeIndex >= lastRanked.length) return false;
        const s = lastRanked[activeIndex];
        selected = { id: s.id, displayText: s.text };
        searchInput.value = s.text;
        closeSuggest();
        return true;
      }

      // ============================
      // Clear Screen helpers
      // ============================
      function showClearScreen(a) {
        // ‚òÖ topPanel „Çí‰∏∏„Åî„Å®Ê∂à„Åô
        topPanel.classList.add("hidden");

        closeSuggest();

        const title = a?.title?.english || a?.title?.romaji || "(no title)";
        clearTitle.textContent = title;
        clearCover.src = a?.img || "";
        clearCover.alt = title;

        clearScreen.classList.add("show");
      }

      function hideClearScreen() {
        clearScreen.classList.remove("show");
        clearCover.removeAttribute("src");
        clearTitle.textContent = "-";

        // ‚òÖ topPanel „ÇíÊàª„Åô
        topPanel.classList.remove("hidden");
      }

      // ============================
      // Suggest rendering (local json)
      // ============================
      function renderSuggest(ranked) {
        lastRanked = ranked;
        suggestBox.innerHTML = "";

        for (let i = 0; i < ranked.length; i++) {
          const s = ranked[i];
          const div = document.createElement("div");
          div.className = "sitem";
          div.dataset.index = String(i);

          div.innerHTML = `
            <div class="stitle">${escapeHtml(s.text)}</div>
            <div class="ssub">${s.kind === "english" ? "English" : "Romaji"} ‚Ä¢ ID:${s.id}</div>
          `;

          div.addEventListener("mouseenter", () => setActive(i));

          div.addEventListener("mousedown", (e) => {
            e.preventDefault();
            selected = { id: s.id, displayText: s.text };
            searchInput.value = s.text;
            closeSuggest();
            syncGuessBtn();
          });

          suggestBox.appendChild(div);
        }

        if (ranked.length) {
          suggestBox.classList.add("show");
          activeIndex = 0;
          setActive(0);
        } else {
          closeSuggest();
        }
      }

      let debounceTimer = null;
      async function onType() {
        const q = searchInput.value.trim();
        selected = null;

        if (!q) {
          closeSuggest();
          syncGuessBtn();
          return;
        }

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          try {
            await loadAnimeJsonOnce();
            const ranked = rankSuggestLocal(q);
            renderSuggest(ranked);
            syncGuessBtn();
          } catch (e) {
            console.error(e);
            closeSuggest();
            syncGuessBtn();
          }
        }, 60);
      }

      // ============================
      // Start game (random answer)
      // ============================
      async function startGame() {
        try {
          // ‚òÖ „ÇØ„É™„Ç¢ÁîªÈù¢„ÇíÁ¢∫ÂÆü„Å´Èö†„ÅôÔºà„ÄåÈñãÂßãÊôÇ„Åã„ÇâË¶ã„Åà„Çã„ÄçÂØæÁ≠ñÔºâ
          hideClearScreen();

          guessBtn.disabled = true;
          searchInput.disabled = true;
          answersBody.innerHTML = "";
          guessedIds = new Set();
          selected = null;
          answer = null;
          started = false;

          setStatus("Loading random anime...");

          // „Çµ„Ç∏„Çß„Çπ„ÉàJSON„ÅØ„Åì„Åì„ÅßÂÖàË™≠„Åø
          await loadAnimeJsonOnce();

          // Ë®≠ÂÆö„Åã„ÇâÁ≠î„ÅàIDÂèñÂæóÔºàÂ§ñÈÉ®jsÔºâ
          const pickedAnimeId = await getRandomAnswerAnimeIdFromLocalStorage();

          const detail = await anilist(Q_DETAIL, { id: pickedAnimeId });
          answer = normalizeDetail(detail.Media);
          console.log("ANSWER:", answer);

          started = true;
          searchInput.disabled = false;
          selected = null;
          searchInput.value = "";
          guessBtn.disabled = true;
          giveUpBtn.disabled = false;
          setStatus("Ready. Type a title and guess!");
          searchInput.focus();
        } catch (e) {
          console.error(e);
          setStatus("Failed to start: " + e.message);
        }
      }

      function normalizeDetail(m) {
        return {
          id: m.id,
          title: {
            english: (m.title?.english || "").trim(),
            romaji: (m.title?.romaji || "").trim(),
          },
          year: m.startDate?.year ?? null,
          genres: (m.genres || []).filter(Boolean),
          themes: extractThemes(m.tags || []),
          studio: pickMainStudio(m.studios),
          source: fmtSource(m.source),
          score: m.averageScore ?? null,
          score10: m.averageScore != null ? m.averageScore / 10 : null,
          img: m.coverImage?.large || "",
        };
      }

      // ============================
      // Guess
      // ============================
      async function doGuess() {
        if (!started || !answer) return;
        if (!selected?.id) return;

        const sid = Number(selected.id);
        if (guessedIds.has(sid)) {
          setWarnStatus("Already guessed that title!");

          searchInput.value = "";
          selected = null;
          closeSuggest();
          syncGuessBtn();
          searchInput.focus();
          return;
        }
        try {
          guessBtn.disabled = true;
          setStatus("Checking...");

          const detail = await anilist(Q_DETAIL, { id: selected.id });
          const g = normalizeDetail(detail.Media);
          appendRow(g, answer);
          guessedIds.add(g.id);
          if (g.id === answer.id) {
            setStatus("Correct! üéâ");
            searchInput.disabled = true;
            giveUpBtn.disabled = true;
            closeSuggest();

            // ‚òÖ „Åì„Åì„Åß„ÇØ„É™„Ç¢ÁîªÈù¢„ÇíË°®Á§∫
            showClearScreen(answer);
          } else {
            setStatus("Not yet. Try again.");
            selected = null;
            searchInput.value = "";
            searchInput.focus();
          }
        } catch (e) {
          console.error(e);
          setStatus("Failed: " + e.message);
        } finally {
          syncGuessBtn();
        }
      }

      function giveUp() {
        if (!started || !answer) return;

        setStatus("Gave up‚Ä¶ üò¢");

        // ÂÖ•Âäõ‰∏çËÉΩ„Å´
        started = false;
        searchInput.disabled = true;
        guessBtn.disabled = true;
        giveUpBtn.disabled = true;
        closeSuggest();

        // ‚òÖ Ê≠£Ëß£„Åß„ÅØ„Å™„ÅÑ„Åå„ÄÅÁ≠î„Åà„ÇíÂÖ¨Èñã„Åó„Å¶„ÇØ„É™„Ç¢ÁîªÈù¢„Å∏
        showClearScreen(answer);
      }
      function appendRow(g, a) {
        const tr = document.createElement("tr");

        const gTitle = g.title.english || g.title.romaji || "(no title)";
        const titleOk = g.id === a.id;

        const yearOk = g.year != null && a.year != null && g.year === a.year;
        const yearDir =
          !yearOk && g.year != null && a.year != null
            ? g.year < a.year
              ? "up"
              : "down"
            : null;

        const gs = g.score10;
        const as = a.score10;
        const scoreOk = gs != null && as != null && Math.abs(gs - as) < 1e-9;
        const scoreDir =
          !scoreOk && gs != null && as != null
            ? gs < as
              ? "up"
              : "down"
            : null;

        const studioOk =
          norm(g.studio) && norm(a.studio) && norm(g.studio) === norm(a.studio);
        const sourceOk =
          norm(g.source) && norm(a.source) && norm(g.source) === norm(a.source);

        const aGenres = new Set(a.genres);
        const aThemes = new Set(a.themes);

        const thTitle = document.createElement("th");
        thTitle.innerHTML = `<div class="${colorClass(titleOk)}" style="font-size:22px;font-weight:800;line-height:1.2">${escapeHtml(gTitle)}</div>`;
        tr.appendChild(thTitle);

        const tdYear = document.createElement("td");
        tdYear.className = "center";
        tdYear.innerHTML = `<div class="${colorClass(yearOk)}" style="font-size:22px;font-weight:800">
          ${g.year ?? "-"}${yearDir ? arrowIcon(yearDir) : ""}
        </div>`;
        tr.appendChild(tdYear);

        const tdGenres = document.createElement("td");
        tdGenres.className = "center";
        tdGenres.appendChild(makeLinesCell(g.genres, aGenres));
        tr.appendChild(tdGenres);

        const tdThemes = document.createElement("td");
        tdThemes.className = "center";
        tdThemes.appendChild(makeLinesCell(g.themes, aThemes));
        tr.appendChild(tdThemes);

        const tdStudio = document.createElement("td");
        tdStudio.className = "center";
        tdStudio.innerHTML = `<div class="${colorClass(studioOk)}" style="font-size:20px;font-weight:800">${escapeHtml(g.studio || "-")}</div>`;
        tr.appendChild(tdStudio);

        const tdSource = document.createElement("td");
        tdSource.className = "center";
        tdSource.innerHTML = `<div class="${colorClass(sourceOk)}" style="font-size:20px;font-weight:800">${escapeHtml(g.source || "-")}</div>`;
        tr.appendChild(tdSource);

        const tdScore = document.createElement("td");
        tdScore.className = "center";
        tdScore.innerHTML = `<div class="${colorClass(scoreOk)}" style="font-size:22px;font-weight:800">
          ${gs != null ? gs.toFixed(2) : "-"}${scoreDir ? arrowIcon(scoreDir) : ""}
        </div>`;
        tr.appendChild(tdScore);

        answersBody.prepend(tr);
      }

      // ============================
      // Events
      // ============================
      searchInput.addEventListener("input", onType);
      searchInput.addEventListener("focus", () => openSuggest());
      searchInput.addEventListener("blur", () => setTimeout(closeSuggest, 120));

      searchInput.addEventListener("keydown", (e) => {
        if (!started) return;

        const isOpen = suggestBox.classList.contains("show");
        const items = Array.from(suggestBox.querySelectorAll(".sitem"));

        if (isOpen && items.length) {
          if (e.key === "ArrowDown") {
            e.preventDefault();
            setActive(activeIndex + 1);
            return;
          }
          if (e.key === "ArrowUp") {
            e.preventDefault();
            setActive(activeIndex - 1);
            return;
          }
          if (e.key === "Enter") {
            e.preventDefault();
            chooseActive();
            syncGuessBtn();
            return;
          }
          if (e.key === "Escape") {
            e.preventDefault();
            closeSuggest();
            syncGuessBtn();
            return;
          }
        }

        if (e.key === "Enter") {
          e.preventDefault();
          if (selected?.id) doGuess();
        }
      });

      guessBtn.addEventListener("click", doGuess);

      giveUpBtn.addEventListener("click", giveUp);
      function syncGuessBtn() {
        guessBtn.disabled = !started || !selected?.id;
      }

      // Clear screen buttons
      playAgainBtn.addEventListener("click", () => {
        startGame(); // Âêå„Éö„Éº„Ç∏„ÅßÂÜç„Çπ„Çø„Éº„Éà
      });

      backToTitleBtn.addEventListener("click", () => {
        window.location.href = "./index.html";
      });
      // „ÇØ„É™„ÉÉ„ÇØ‰øùÈô∫
      document.addEventListener("click", () => syncGuessBtn());

      window.addEventListener("DOMContentLoaded", () => {
        // ÂàùÊúü„Çπ„ÉÜ„Éº„Çø„Çπ
        setStatus("Loading...");
        startGame();
      });

      // ‚òÖ Ê≥®ÊÑè:
      // fetch„Åß„É≠„Éº„Ç´„É´JSONË™≠„ÇÄ„Å´„ÅØ„ÄÅfile:// Áõ¥Èñã„Åç„Å†„Å®CORSÁ≠â„ÅßÂ§±Êïó„Åô„Çã„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
      // `npx serve` / `python -m http.server` „Å™„Å©„Åß http:// „ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
    </script>
  </body>
</html>
