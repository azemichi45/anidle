<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anidle</title>
    <link rel="stylesheet" href="./styles/common.css" />
    <link rel="stylesheet" href="./styles/game.css" />
  </head>

  <body>
    <div class="wrap">
      <h1>Anidle</h1>

      <div id="topPanel" class="top">
        <div class="row">
          <div id="inputArea" class="searchBox">
            <input
              id="searchInput"
              type="text"
              placeholder="Type anime title (English / Romaji)..."
              autocomplete="off"
              disabled
            />
            <div id="suggestBox" class="suggest"></div>
          </div>

          <button id="guessBtn" disabled>Guess</button>
          <button id="giveUpBtn" disabled class="btnGhost">Give Up</button>
          <div id="status" class="status">Press ‚ÄúGame Start‚Äù.</div>
        </div>

        <div class="legend">
          <span class="chip"><span class="ok">GREEN</span> = match</span>
          <span class="chip"><span class="ng">RED</span> = not match</span>
          <span class="chip">Year/Score: ‚Üë‚Üì indicates higher/lower than answer</span>
          <span class="chip">Genres/Themes: each item individually colored</span>
        </div>
      </div>

      <section id="clearScreen" class="clearScreen" aria-label="Clear screen">
        <div class="clearInner">
          <div class="clearImg">
            <img id="clearCover" alt="Cover" />
          </div>
          <div id="clearTitle" class="clearTitle">-</div>
          <div class="clearBtns">
            <button id="playAgainBtn" class="btnPrimary">Play Again</button>
            <button id="backToTitleBtn" class="btnGhost">Back to Title</button>
          </div>
        </div>
      </section>

      <div id="gameResult"></div>

      <div id="tableWrap" class="tableWrap" style="margin-top: 14px">
        <table aria-label="Anidle answers">
          <thead>
            <tr>
              <th>Title</th>
              <th class="center">Year</th>
              <th class="center">Genres</th>
              <th class="center">Themes</th>
              <th class="center">Studio</th>
              <th class="center">Source</th>
              <th class="center">Score</th>
            </tr>
          </thead>
          <tbody id="answersBody"></tbody>
        </table>
      </div>
    </div>

    <script type="module">
      import { createSuggestBox } from "./js/suggestBox.js";
      import { getRandomAnswerAnimeIdFromLocalStorage } from "./js/getAnswerAnimeId.js";

      // ============================
      // AniList GraphQL (GuessÁî®)
      // ============================
      const ANILIST_URL = "https://graphql.anilist.co";

      async function anilist(query, variables) {
        const res = await fetch(ANILIST_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify({ query, variables }),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`AniList HTTP ${res.status}: ${text}`);
        }
        const json = await res.json();
        if (json.errors?.length) {
          throw new Error(json.errors.map((e) => e.message).join(" / "));
        }
        return json.data;
      }

      const Q_DETAIL = `
        query($id:Int){
          Media(id:$id, type:ANIME){
            id
            title{ romaji english }
            startDate{ year }
            genres
            tags{ name rank isMediaSpoiler isGeneralSpoiler }
            studios(isMain:true){ nodes{ name } }
            source
            averageScore
            coverImage { large }
          }
        }
      `;

      // ============================
      // Utils
      // ============================
      function norm(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFKD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9\s]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function fmtSource(src) {
        if (!src) return "";
        return src
          .toLowerCase()
          .replace(/_/g, " ")
          .replace(/\b\w/g, (c) => c.toUpperCase());
      }

      function pickMainStudio(studios) {
        return studios?.nodes?.[0]?.name || "";
      }

      function extractThemes(tags) {
        return (tags || [])
          .filter((t) => !t.isMediaSpoiler && !t.isGeneralSpoiler)
          .sort((a, b) => (b.rank || 0) - (a.rank || 0))
          .slice(0, 6)
          .map((t) => t.name);
      }

      function arrowIcon(dir) {
        if (dir === "up") {
          return `
          <span class="arrow" title="Higher than answer">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M5.71 9.7c.39.39 1.02.39 1.41 0L11 5.83V21c0 .55.45 1 1 1s1-.45 1-1V5.83l3.88 3.88c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41L12.7 2.7a.9959.9959 0 0 0-1.41 0L5.71 8.29c-.39.39-.39 1.03 0 1.41z"></path>
            </svg>
          </span>`;
        }
        return `
        <span class="arrow" title="Lower than answer">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M18.3 14.29a.9959.9959 0 0 0-1.41 0L13 18.17V3c0-.55-.45-1-1-1s-1 .45-1 1v15.18L7.12 14.3a.9959.9959 0 0 0-1.41 0c-.39.39-.39 1.02 0 1.41l5.59 5.59c.39.39 1.02.39 1.41 0l5.59-5.59c.38-.39.38-1.03 0-1.42z"></path>
          </svg>
        </span>`;
      }

      function colorClass(ok) {
        return ok ? "ok" : "ng";
      }

      function makeLinesCell(items, answerSet) {
        const div = document.createElement("div");
        div.className = "cellLines";
        if (!items?.length) {
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "-";
          div.appendChild(p);
          return div;
        }
        for (const x of items) {
          const p = document.createElement("div");
          p.className = colorClass(answerSet.has(x));
          p.textContent = x;
          div.appendChild(p);
        }
        return div;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function setWarnStatus(msg) {
        statusEl.textContent = msg;
        statusEl.classList.add("warn", "shake");
        setTimeout(() => statusEl.classList.remove("shake"), 400);
      }

      // ============================
      // Suggest data loader
      // ============================
      const SUGGEST_JSON_URL = "./data/anilist_anime_id_titles.json";
      let animeLoaded = false;
      let animeArrCache = null;

      async function loadAnimeJsonOnce() {
        if (animeLoaded) return animeArrCache;
        const res = await fetch(SUGGEST_JSON_URL, { cache: "force-cache" });
        if (!res.ok) throw new Error(`Failed to load ${SUGGEST_JSON_URL} (${res.status})`);
        animeArrCache = await res.json();
        animeLoaded = true;
        return animeArrCache;
      }

      // ============================
      // DOM
      // ============================
      const topPanel = document.getElementById("topPanel");
      const searchInput = document.getElementById("searchInput");
      const suggestBox = document.getElementById("suggestBox");
      const guessBtn = document.getElementById("guessBtn");
      const giveUpBtn = document.getElementById("giveUpBtn");
      const statusEl = document.getElementById("status");
      const answersBody = document.getElementById("answersBody");

      const clearScreen = document.getElementById("clearScreen");
      const clearCover = document.getElementById("clearCover");
      const clearTitle = document.getElementById("clearTitle");
      const playAgainBtn = document.getElementById("playAgainBtn");
      const backToTitleBtn = document.getElementById("backToTitleBtn");

      // ============================
      // Game state
      // ============================
      let answer = null;
      let selected = null; // { id, displayText }
      let started = false;
      let guessedIds = new Set();
      let isGuessing = false;

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      function syncGuessBtn() {
        guessBtn.disabled = !started || !selected?.id;
      }

      // Clear screen
      function showClearScreen(a) {
        topPanel.classList.add("hidden");
        const title = a?.title?.english || a?.title?.romaji || "(no title)";
        clearTitle.textContent = title;
        clearCover.src = a?.img || "";
        clearCover.alt = title;
        clearScreen.classList.add("show");
      }
      function hideClearScreen() {
        clearScreen.classList.remove("show");
        clearCover.removeAttribute("src");
        clearTitle.textContent = "-";
        topPanel.classList.remove("hidden");
      }

      function normalizeDetail(m) {
        return {
          id: m.id,
          title: {
            english: (m.title?.english || "").trim(),
            romaji: (m.title?.romaji || "").trim(),
          },
          year: m.startDate?.year ?? null,
          genres: (m.genres || []).filter(Boolean),
          themes: extractThemes(m.tags || []),
          studio: pickMainStudio(m.studios),
          source: fmtSource(m.source),
          score: m.averageScore ?? null,
          score10: m.averageScore != null ? m.averageScore / 10 : null,
          img: m.coverImage?.large || "",
        };
      }

      async function startGame() {
        try {
          hideClearScreen();

          guessBtn.disabled = true;
          searchInput.disabled = true;
          answersBody.innerHTML = "";
          guessedIds = new Set();
          selected = null;
          answer = null;
          started = false;

          setStatus("Loading random anime...");

          // „Çµ„Ç∏„Çß„Çπ„ÉàJSON„ÇíÂÖà„Å´Ë™≠„ÅøÔºàsuggestBoxÂÅ¥„Åß„ÇÇ‰Ωø„ÅÜÔºâ
          await loadAnimeJsonOnce();

          const pickedAnimeId = await getRandomAnswerAnimeIdFromLocalStorage();
          const detail = await anilist(Q_DETAIL, { id: pickedAnimeId });

          answer = normalizeDetail(detail.Media);
          started = true;

          searchInput.disabled = false;
          searchInput.value = "";
          selected = null;

          giveUpBtn.disabled = false;
          setStatus("Ready. Type a title and guess!");
          searchInput.focus();
          syncGuessBtn();
        } catch (e) {
          console.error(e);
          setStatus("Failed to start: " + e.message);
        }
      }

      async function doGuess() {
        if (isGuessing) return;
        if (!started || !answer) return;
        if (!selected?.id) return;

        isGuessing = true;

        const sid = Number(selected.id);
        if (guessedIds.has(sid)) {
          setWarnStatus("Already guessed that title!");
          searchInput.value = "";
          selected = null;
          syncGuessBtn();
          searchInput.focus();
          isGuessing = false;
          return;
        }

        try {
          guessBtn.disabled = true;
          setStatus("Checking...");

          const detail = await anilist(Q_DETAIL, { id: selected.id });
          const g = normalizeDetail(detail.Media);

          appendRow(g, answer);
          guessedIds.add(g.id);

          if (g.id === answer.id) {
            setStatus("Correct! üéâ");
            searchInput.disabled = true;
            giveUpBtn.disabled = true;
            showClearScreen(answer);
          } else {
            setStatus("Not yet. Try again.");
            selected = null;
            searchInput.value = "";
            searchInput.focus();
          }
        } catch (e) {
          console.error(e);
          setStatus("Failed: " + e.message);
        } finally {
          isGuessing = false;
          syncGuessBtn();
        }
      }

      function giveUp() {
        if (!started || !answer) return;

        setStatus("Gave up‚Ä¶ üò¢");
        started = false;
        searchInput.disabled = true;
        guessBtn.disabled = true;
        giveUpBtn.disabled = true;
        showClearScreen(answer);
      }

      function appendRow(g, a) {
        const tr = document.createElement("tr");

        const gTitle = g.title.english || g.title.romaji || "(no title)";
        const titleOk = g.id === a.id;

        const yearOk = g.year != null && a.year != null && g.year === a.year;
        const yearDir =
          !yearOk && g.year != null && a.year != null
            ? g.year < a.year ? "up" : "down"
            : null;

        const gs = g.score10;
        const as = a.score10;
        const scoreOk = gs != null && as != null && Math.abs(gs - as) < 1e-9;
        const scoreDir =
          !scoreOk && gs != null && as != null
            ? gs < as ? "up" : "down"
            : null;

        const studioOk = norm(g.studio) && norm(a.studio) && norm(g.studio) === norm(a.studio);
        const sourceOk = norm(g.source) && norm(a.source) && norm(g.source) === norm(a.source);

        const aGenres = new Set(a.genres);
        const aThemes = new Set(a.themes);

        const thTitle = document.createElement("th");
        thTitle.innerHTML = `<div class="${colorClass(titleOk)}" style="font-size:22px;font-weight:800;line-height:1.2">${escapeHtml(gTitle)}</div>`;
        tr.appendChild(thTitle);

        const tdYear = document.createElement("td");
        tdYear.className = "center";
        tdYear.innerHTML = `<div class="${colorClass(yearOk)}" style="font-size:22px;font-weight:800">
          ${g.year ?? "-"}${yearDir ? arrowIcon(yearDir) : ""}
        </div>`;
        tr.appendChild(tdYear);

        const tdGenres = document.createElement("td");
        tdGenres.className = "center";
        tdGenres.appendChild(makeLinesCell(g.genres, aGenres));
        tr.appendChild(tdGenres);

        const tdThemes = document.createElement("td");
        tdThemes.className = "center";
        tdThemes.appendChild(makeLinesCell(g.themes, aThemes));
        tr.appendChild(tdThemes);

        const tdStudio = document.createElement("td");
        tdStudio.className = "center";
        tdStudio.innerHTML = `<div class="${colorClass(studioOk)}" style="font-size:20px;font-weight:800">${escapeHtml(g.studio || "-")}</div>`;
        tr.appendChild(tdStudio);

        const tdSource = document.createElement("td");
        tdSource.className = "center";
        tdSource.innerHTML = `<div class="${colorClass(sourceOk)}" style="font-size:20px;font-weight:800">${escapeHtml(g.source || "-")}</div>`;
        tr.appendChild(tdSource);

        const tdScore = document.createElement("td");
        tdScore.className = "center";
        tdScore.innerHTML = `<div class="${colorClass(scoreOk)}" style="font-size:22px;font-weight:800">
          ${gs != null ? gs.toFixed(2) : "-"}${scoreDir ? arrowIcon(scoreDir) : ""}
        </div>`;
        tr.appendChild(tdScore);

        answersBody.prepend(tr);
      }

      // ============================
      // Wire UI
      // ============================
      guessBtn.addEventListener("click", doGuess);
      giveUpBtn.addEventListener("click", giveUp);

      playAgainBtn.addEventListener("click", startGame);
      backToTitleBtn.addEventListener("click", () => (window.location.href = "./index.html"));

      // ============================
      // Suggest (module)
      // ============================
      const suggest = createSuggestBox({
        inputEl: searchInput,
        suggestEl: suggestBox,
        data: loadAnimeJsonOnce,
        limit: 20,
        onSelect: ({ id, text }) => {
          selected = { id, displayText: text };
          syncGuessBtn();
        },
      });

      // Enter„Ç≠„Éº„Åß Guess „ÇÇ„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºà„Çµ„Ç∏„Çß„Çπ„Éà„ÅßEnter„Çí‰Ωø„Å£„ÅüÂæå„Å´Ôºâ
      searchInput.addEventListener("keydown", (e) => {
        if (!started) return;
        if (e.key === "Enter") {
          // suggestBox.js ÂÅ¥„ÅåÈñã„ÅÑ„Å¶„Çã„Å®„Åç„ÅØ„Åù„Å£„Å°„ÅåÂá¶ÁêÜ„Åó„Å¶„Çã
          // „Åì„Åì„ÅØ„ÄåÁ¢∫ÂÆöÊ∏à„Åø selected „Åå„ÅÇ„ÇãÂ†¥Âêà„Äç„ÅÆ„Åø Guess
          if (selected?.id) {
            e.preventDefault();
            doGuess();
          }
        }
      });

      window.addEventListener("DOMContentLoaded", async () => {
        setStatus("Loading...");
        await suggest.init(); // ‚òÖ„Åì„Çå„ÅåÁÑ°„ÅÑ„Å®„Çµ„Ç∏„Çß„Çπ„Éà„ÅåÂãï„Åã„Å™„ÅÑ
        await startGame();
      });
    </script>
  </body>
</html>
