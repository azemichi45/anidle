<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anidle</title>
    <style>
      :root {
        --bg: #0e0f12;
        --panel: #17191f;
        --panel2: #12141a;
        --line: #2a2f3a;
        --text: #e9eef7;
        --muted: #a9b3c7;
        --green: #35c16b;
        --red: #ff4d4d;
        --shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
        --radius: 14px;
        --warn: #f5c84c;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0c0d11, #0e0f12);
        color: var(--text);
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial;
      }

      /* ===== Title layout ===== */
      .page {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .card {
        width: min(720px, 100%);
        border: 1px solid var(--line);
        background: var(--panel);
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding: 18px;
      }
      .hero {
        padding: 12px 10px 16px;
        border-bottom: 1px solid var(--line);
        margin-bottom: 16px;
      }
      .hero .sub {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
        line-height: 1.5;
      }

      .actions {
        display: flex;
        gap: 10px;
        padding: 10px;
        flex-wrap: wrap;
      }
      .btn {
        border: 1px solid var(--line);
        background: var(--panel2);
        color: var(--text);
        border-radius: 14px;
        padding: 12px 16px;
        cursor: pointer;
        box-shadow: var(--shadow);
      }
      .btn:hover {
        filter: brightness(1.06);
      }
      .btn.primary {
        border-color: rgba(53, 193, 107, 0.35);
        background: rgba(53, 193, 107, 0.12);
      }
      .btn.ghost {
        background: transparent;
        box-shadow: none;
      }

      .summary {
        margin-top: 10px;
        padding: 10px;
        border-top: 1px solid var(--line);
        color: var(--muted);
        font-size: 12px;
        display: grid;
        gap: 6px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.03);
        padding: 6px 10px;
        border-radius: 999px;
        width: fit-content;
      }

      /* ===== Modal ===== */
      .backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .backdrop.open {
        display: flex;
      }

      .modal {
        width: min(980px, 100%);
        max-height: min(860px, 92vh);
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 18px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        border-bottom: 1px solid var(--line);
        background: linear-gradient(180deg, #1a1d25, #17191f);
      }
      .modal-header .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pill {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.03);
      }
      .icon-btn {
        border: 1px solid var(--line);
        background: transparent;
        color: var(--text);
        width: 36px;
        height: 36px;
        border-radius: 12px;
        cursor: pointer;
      }
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .modal-body {
        display: flex;
        gap: 12px;
        padding: 12px;
        overflow: hidden;
        flex: 1;
      }
      .content {
        flex: 1;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--line);
        border-radius: 16px;
        overflow: auto;
        padding: 14px;
      }

      .section {
        border: 1px solid var(--line);
        background: var(--panel2);
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 14px;
      }
      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .section-title h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.02em;
      }
      .section-title .hint {
        color: var(--muted);
        font-size: 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }
      @media (max-width: 860px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .field {
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.18);
        border-radius: 14px;
        padding: 12px;
      }
      .field-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .field-head label {
        font-size: 13px;
      }
      .field-head .value {
        font-size: 12px;
        color: var(--muted);
      }

      .text-input {
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        outline: none;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .mini-btn {
        border: 1px solid var(--line);
        background: transparent;
        color: var(--text);
        border-radius: 12px;
        padding: 8px 12px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .mini-btn:hover {
        background: rgba(255, 255, 255, 0.04);
      }
      .mini-btn.danger {
        border-color: rgba(255, 77, 77, 0.35);
        color: rgba(255, 170, 170, 0.95);
      }
      .mini-btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .check {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 6px;
        color: var(--muted);
        font-size: 12px;
      }
      .check input {
        width: 16px;
        height: 16px;
      }

      .footer {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.02);
      }
      .footer .left,
      .footer .right {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      /* ===== Toast ===== */
      .toast {
        font-size: 12px;
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        gap: 10px;
        min-height: 20px;
        padding: 2px 0;
      }
      .toast .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.25);
      }
      .toast.info .dot {
        background: rgba(90, 160, 255, 0.85);
      }
      .toast.ok .dot {
        background: rgba(53, 193, 107, 0.85);
      }
      .toast.warn .dot {
        background: rgba(245, 200, 76, 0.95);
      }
      .toast.err .dot {
        background: rgba(255, 77, 77, 0.95);
      }
      .toast .msg {
        line-height: 1.4;
      }

      /* ===== Loader ===== */
      .spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.18);
        border-top-color: rgba(255, 255, 255, 0.75);
        animation: spin 0.8s linear infinite;
        display: none;
      }
      .spinner.show {
        display: inline-block;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* user list */
      .user-list {
        display: grid;
        gap: 8px;
        margin-top: 10px;
      }
      .user-item {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.18);
        border-radius: 14px;
      }
      .user-item .name {
        flex: 1;
        color: var(--text);
        font-size: 13px;
      }
      .user-item .meta {
        color: var(--muted);
        font-size: 12px;
      }

      /* Inline validation hint */
      .help {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.4;
      }
      .help strong {
        color: rgba(233, 238, 247, 0.95);
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="card">
        <div class="hero">
          <div style="font-size: 18px; font-weight: 700">Title Screen</div>
          <div class="sub">
            Settings are saved to <strong>localStorage</strong> (the game page
            can read them on start).
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnStart">Start Game</button>
          <button class="btn" id="btnSettings">Settings</button>
          <button class="btn ghost" id="btnReset">Reset Settings</button>
        </div>

        <div class="summary" id="summary"></div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="backdrop" id="backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="modal-header">
          <div class="left">
            <div class="pill">Settings</div>
          </div>
          <button class="icon-btn" id="closeBtn" aria-label="Close">×</button>
        </div>

        <div class="modal-body">
          <div class="content">
            <!-- Users -->
            <section class="section">
              <div class="section-title">
                <h3>AniList Users</h3>
                <div class="hint">Multiple users allowed (username only)</div>
              </div>

              <div class="field">
                <div class="field-head">
                  <label>Add a user</label>
                  <span class="value">Enter / Add</span>
                </div>
                <div class="row">
                  <input
                    class="text-input"
                    id="inpUser"
                    autocomplete="off"
                    placeholder="Type an AniList username…"
                  />
                  <button class="mini-btn" id="btnAddUser">
                    <span
                      class="spinner"
                      id="spinAddUser"
                      aria-hidden="true"
                    ></span>
                    <span id="lblAddUser">Add</span>
                  </button>
                </div>

                <div class="help" id="userHelp">
                  Tip: Usernames are case-sensitive on some sites, but AniList
                  usually handles them well. If it fails, try the exact
                  spelling.
                </div>

                <div class="user-list" id="userList"></div>
              </div>
            </section>

            <!-- Pool rule -->
            <section class="section">
              <div class="section-title">
                <h3>Pool Rule</h3>
                <div class="hint">Combine all users by AND / OR</div>
              </div>

              <div class="grid">
                <div class="field">
                  <div class="field-head">
                    <label>Combine method</label>
                    <span class="value" id="valCombine">OR</span>
                  </div>
                  <div class="row">
                    <label class="check" style="margin: 0">
                      <input type="radio" name="combine" value="OR" />
                      <span>OR (Union)</span>
                    </label>
                    <label class="check" style="margin: 0">
                      <input type="radio" name="combine" value="AND" />
                      <span>AND (Intersection)</span>
                    </label>
                  </div>
                </div>

                <div class="field">
                  <div class="field-head">
                    <label>Target statuses</label>
                    <span class="value" id="valStatuses">WATCHING…</span>
                  </div>

                  <label class="check">
                    <input type="checkbox" value="CURRENT" />
                    <span>Watching (CURRENT)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="COMPLETED" />
                    <span>Completed (COMPLETED)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="PLANNING" />
                    <span>Plan to Watch (PLANNING)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="PAUSED" />
                    <span>Paused (PAUSED)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="DROPPED" />
                    <span>Dropped (DROPPED)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="REPEATING" />
                    <span>Rewatching (REPEATING)</span>
                  </label>
                </div>
              </div>
            </section>
          </div>
        </div>

        <div class="footer">
          <div class="left">
            <span class="toast" id="toast">
              <span class="dot" aria-hidden="true"></span>
              <span class="msg" id="toastMsg"></span>
            </span>
          </div>
          <div class="right">
            <button class="mini-btn" id="btnCancel">Cancel</button>
            <button class="mini-btn" id="btnSave">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ========= storage key =========
      const STORAGE_KEY = "anidle_settings_v2";

      // ========= default settings =========
      function defaultSettings() {
        return {
          anilistUsernames: [],
          combine: "OR", // "OR" | "AND"
          statuses: ["CURRENT", "COMPLETED", "PLANNING"], // AniList MediaListStatus
        };
      }

      // ========= helpers =========
      const el = (id) => document.getElementById(id);

      function setToast(msg, type = "info", keepMs = 2400) {
        const toastEl = el("toast");
        const msgEl = el("toastMsg");
        msgEl.textContent = msg || "";
        toastEl.className = `toast ${type}`;
        if (!msg) return;
        window.clearTimeout(setToast._t);
        setToast._t = window.setTimeout(() => {
          msgEl.textContent = "";
          toastEl.className = "toast";
        }, keepMs);
      }

      function loadSettings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return defaultSettings();
          const parsed = JSON.parse(raw);
          // merge defaults (for future extension)
          return { ...defaultSettings(), ...parsed };
        } catch {
          return defaultSettings();
        }
      }

      function saveSettings(s) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      }

      function normalizeUserName(name) {
        return String(name || "")
          .trim()
          .replace(/^@/, "")
          .replace(/\s+/g, "");
      }

      function uniq(arr) {
        return Array.from(new Set(arr));
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ========= AniList check =========
      async function anilistUserExists(username) {
        const query = `
          query ($name: String!) {
            User(name: $name) { id }
          }
        `;

        try {
          const res = await fetch("https://graphql.anilist.co", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              query,
              variables: { name: username },
            }),
          });

          // If AniList rate-limits or errors, try to give a helpful message.
          if (!res.ok) {
            // 429: Too Many Requests
            if (res.status === 429) {
              return { ok: false, reason: "rate_limit" };
            }
            return { ok: false, reason: "http_error", status: res.status };
          }

          const json = await res.json();

          // GraphQL errors (e.g., invalid query) -> treat as failure
          if (json?.errors?.length) {
            return { ok: false, reason: "graphql_error" };
          }

          // User not found => data.User === null
          const exists = !!json?.data?.User;
          return { ok: true, exists };
        } catch (e) {
          console.error("AniList check failed", e);
          return { ok: false, reason: "network" };
        }
      }

      // ========= UI render =========
      let settings = loadSettings();
      let draft = structuredClone(settings);

      function renderSummary() {
        const s = loadSettings();
        const users = s.anilistUsernames.length
          ? s.anilistUsernames.join(", ")
          : "(none)";
        const statuses = s.statuses.length ? s.statuses.join(", ") : "(none)";
        el("summary").innerHTML = `
          <div class="chip">Users: ${escapeHtml(users)}</div>
          <div class="chip">Combine: ${escapeHtml(s.combine)}</div>
          <div class="chip">Statuses: ${escapeHtml(statuses)}</div>
        `;
      }

      function renderModal() {
        // combine
        el("valCombine").textContent = draft.combine;
        for (const r of document.querySelectorAll('input[name="combine"]')) {
          r.checked = r.value === draft.combine;
        }

        // statuses
        const selected = new Set(draft.statuses || []);
        for (const cb of statusCheckboxes()) {
          cb.checked = selected.has(cb.value);
        }
        el("valStatuses").textContent = draft.statuses.length
          ? draft.statuses.join(", ")
          : "(none)";

        // users
        const list = el("userList");
        list.innerHTML = "";
        if (!draft.anilistUsernames.length) {
          const div = document.createElement("div");
          div.className = "user-item";
          div.innerHTML = `<div class="name" style="color: var(--muted)">(no users)</div>`;
          list.appendChild(div);
        } else {
          draft.anilistUsernames.forEach((u, idx) => {
            const row = document.createElement("div");
            row.className = "user-item";
            row.innerHTML = `
              <div class="name">${escapeHtml(u)}</div>
              <div class="meta">#${idx + 1}</div>
              <button class="mini-btn danger" data-del="${idx}">Remove</button>
            `;
            list.appendChild(row);
          });
        }
      }

      function statusCheckboxes() {
        return Array.from(
          el("backdrop").querySelectorAll('input[type="checkbox"][value]'),
        );
      }

      // ========= modal open/close =========
      const backdrop = el("backdrop");
      const openModal = () => {
        settings = loadSettings();
        draft = structuredClone(settings);
        renderModal();
        backdrop.classList.add("open");
        backdrop.setAttribute("aria-hidden", "false");
        el("inpUser").value = "";
        setToast("", "info");
      };
      const closeModal = () => {
        backdrop.classList.remove("open");
        backdrop.setAttribute("aria-hidden", "true");
        setToast("", "info");
      };

      el("btnSettings").addEventListener("click", openModal);
      el("closeBtn").addEventListener("click", closeModal);
      el("btnCancel").addEventListener("click", closeModal);
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeModal();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      // ========= start / reset =========
      el("btnStart").addEventListener("click", () => {
        location.href = "game.html";
      });

      el("btnReset").addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        renderSummary();
        setToast("Settings were reset.", "ok");
      });

      // ========= Loading state for Add User =========
      function setAddUserLoading(isLoading) {
        const btn = el("btnAddUser");
        const spin = el("spinAddUser");
        const lbl = el("lblAddUser");
        btn.disabled = isLoading;
        spin.classList.toggle("show", isLoading);
        lbl.textContent = isLoading ? "Checking…" : "Add";
      }

      // ========= modal interactions =========
      // add user
      async function addUserFromInput() {
        const input = el("inpUser");
        const raw = input.value;
        const name = normalizeUserName(raw);

        if (!name) {
          setToast("Please enter a username.", "warn");
          input.focus();
          return;
        }

        if (draft.anilistUsernames.includes(name)) {
          setToast("That user is already in the list.", "warn");
          input.value = "";
          input.focus();
          return;
        }

        setAddUserLoading(true);
        setToast("Checking if the user exists on AniList…", "info", 999999);

        try {
          const res = await anilistUserExists(name);

          if (!res.ok) {
            if (res.reason === "rate_limit") {
              setToast(
                "AniList is rate-limiting requests right now. Please wait a bit and try again.",
                "warn",
                5000,
              );
              return;
            }
            if (res.reason === "network") {
              setToast(
                "Network error. Please check your connection and try again.",
                "err",
                5000,
              );
              return;
            }
            setToast(
              "AniList check failed. Please try again in a moment.",
              "err",
              5000,
            );
            return;
          }

          if (!res.exists) {
            setToast(
              "User not found. Please double-check the spelling and try again.",
              "warn",
              5000,
            );
            input.focus();
            input.select?.();
            return;
          }

          draft.anilistUsernames = [...draft.anilistUsernames, name];
          input.value = "";
          renderModal();
          setToast("User added.", "ok");
        } finally {
          setAddUserLoading(false);
        }
      }

      el("btnAddUser").addEventListener("click", addUserFromInput);
      el("inpUser").addEventListener("keydown", (e) => {
        if (e.key === "Enter") addUserFromInput();
      });

      // remove user (event delegation)
      el("userList").addEventListener("click", (e) => {
        const btn = e.target.closest("[data-del]");
        if (!btn) return;
        const idx = Number(btn.getAttribute("data-del"));
        if (!Number.isFinite(idx)) return;
        draft.anilistUsernames.splice(idx, 1);
        renderModal();
        setToast("User removed.", "ok");
      });

      // combine
      for (const r of document.querySelectorAll('input[name="combine"]')) {
        r.addEventListener("change", () => {
          if (r.checked) {
            draft.combine = r.value;
            renderModal();
          }
        });
      }

      // statuses
      for (const cb of statusCheckboxes()) {
        cb.addEventListener("change", () => {
          const cur = new Set(draft.statuses);
          if (cb.checked) cur.add(cb.value);
          else cur.delete(cb.value);
          draft.statuses = Array.from(cur);
          renderModal();
        });
      }

      // save
      el("btnSave").addEventListener("click", () => {
        const picked = document.querySelector(
          'input[name="combine"]:checked',
        )?.value;
        if (picked === "OR" || picked === "AND") draft.combine = picked;

        // basic validation
        draft.anilistUsernames = uniq(
          draft.anilistUsernames.map(normalizeUserName),
        ).filter(Boolean);

        if (!draft.statuses.length) {
          setToast("Please select at least one status.", "warn", 5000);
          return;
        }

        saveSettings(draft);
        renderSummary();
        setToast("Saved.", "ok");
        closeModal();
      });

      // ========= init =========
      if (!localStorage.getItem(STORAGE_KEY)) saveSettings(defaultSettings());
      renderSummary();
    </script>
  </body>
</html>
