<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anidle</title>
    <link rel="stylesheet" href="./styles/common.css" />
    <link rel="stylesheet" href="./styles/title.css" />
  </head>
  <body>
    <div class="page">
      <div class="card">
        <div class="hero">
          <div style="font-size: 18px; font-weight: 700">Title Screen</div>
          <div class="sub">
            Settings are saved to <strong>localStorage</strong> (the game page
            can read them on start).
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnStart">Start Game</button>
          <button class="btn" id="btnSettings">Settings</button>
          <button class="btn ghost" id="btnReset">Reset Settings</button>
        </div>

        <div class="summary" id="summary"></div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="backdrop" id="backdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="modal-header">
          <div class="left">
            <div class="pill">Settings</div>
          </div>
          <button class="icon-btn" id="closeBtn" aria-label="Close">×</button>
        </div>

        <div class="modal-body">
          <div class="content">
            <!-- Users -->
            <section class="section">
              <div class="section-title">
                <h3>AniList Users</h3>
                <div class="hint">Multiple users allowed (username only)</div>
              </div>

              <div class="field">
                <div class="field-head">
                  <label>Add a user</label>
                  <span class="value">Enter / Add</span>
                </div>
                <div class="row">
                  <input
                    class="text-input"
                    id="inpUser"
                    autocomplete="off"
                    placeholder="Type an AniList username…"
                  />
                  <button class="mini-btn" id="btnAddUser">
                    <span
                      class="spinner"
                      id="spinAddUser"
                      aria-hidden="true"
                    ></span>
                    <span id="lblAddUser">Add</span>
                  </button>
                </div>

                <div class="help" id="userHelp">
                  Tip: Usernames are case-sensitive on some sites, but AniList
                  usually handles them well. If it fails, try the exact
                  spelling.
                </div>

                <div class="user-list" id="userList"></div>
              </div>
            </section>

            <!-- Pool rule -->
            <section class="section">
              <div class="section-title">
                <h3>Pool Rule</h3>
                <div class="hint">Combine all users by AND / OR</div>
              </div>

              <div class="grid">
                <div class="field">
                  <div class="field-head">
                    <label>Combine method</label>
                    <span class="value" id="valCombine">OR</span>
                  </div>
                  <div class="row">
                    <label class="check" style="margin: 0">
                      <input type="radio" name="combine" value="OR" />
                      <span>OR (Union)</span>
                    </label>
                    <label class="check" style="margin: 0">
                      <input type="radio" name="combine" value="AND" />
                      <span>AND (Intersection)</span>
                    </label>
                  </div>
                </div>

                <div class="field">
                  <div class="field-head">
                    <label>Target statuses</label>
                    <span class="value" id="valStatuses">WATCHING…</span>
                  </div>

                  <label class="check">
                    <input type="checkbox" value="CURRENT" />
                    <span>Watching (CURRENT)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="COMPLETED" />
                    <span>Completed (COMPLETED)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="PLANNING" />
                    <span>Plan to Watch (PLANNING)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="PAUSED" />
                    <span>Paused (PAUSED)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="DROPPED" />
                    <span>Dropped (DROPPED)</span>
                  </label>
                  <label class="check">
                    <input type="checkbox" value="REPEATING" />
                    <span>Rewatching (REPEATING)</span>
                  </label>
                </div>
              </div>
            </section>
          </div>
        </div>

        <div class="footer">
          <div class="left">
            <span class="toast" id="toast">
              <span class="dot" aria-hidden="true"></span>
              <span class="msg" id="toastMsg"></span>
            </span>
          </div>
          <div class="right">
            <button class="mini-btn" id="btnCancel">Cancel</button>
            <button class="mini-btn" id="btnSave">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ========= storage key =========
      const STORAGE_KEY = "anidle_settings_v2";

      // ========= default settings =========
      function defaultSettings() {
        return {
          anilistUsernames: [],
          combine: "OR", // "OR" | "AND"
          statuses: ["CURRENT", "COMPLETED", "PLANNING"], // AniList MediaListStatus
        };
      }

      // ========= helpers =========
      const el = (id) => document.getElementById(id);

      function setToast(msg, type = "info", keepMs = 2400) {
        const toastEl = el("toast");
        const msgEl = el("toastMsg");
        msgEl.textContent = msg || "";
        toastEl.className = `toast ${type}`;
        if (!msg) return;
        window.clearTimeout(setToast._t);
        setToast._t = window.setTimeout(() => {
          msgEl.textContent = "";
          toastEl.className = "toast";
        }, keepMs);
      }

      function loadSettings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return defaultSettings();
          const parsed = JSON.parse(raw);
          // merge defaults (for future extension)
          return { ...defaultSettings(), ...parsed };
        } catch {
          return defaultSettings();
        }
      }

      function saveSettings(s) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      }

      function normalizeUserName(name) {
        return String(name || "")
          .trim()
          .replace(/^@/, "")
          .replace(/\s+/g, "");
      }

      function uniq(arr) {
        return Array.from(new Set(arr));
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ========= AniList check =========
      async function anilistUserExists(username) {
        const query = `
          query ($name: String!) {
            User(name: $name) { id }
          }
        `;

        try {
          const res = await fetch("https://graphql.anilist.co", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              query,
              variables: { name: username },
            }),
          });

          // If AniList rate-limits or errors, try to give a helpful message.
          if (!res.ok) {
            // 429: Too Many Requests
            if (res.status === 429) {
              return { ok: false, reason: "rate_limit" };
            }
            return { ok: false, reason: "http_error", status: res.status };
          }

          const json = await res.json();

          // GraphQL errors (e.g., invalid query) -> treat as failure
          if (json?.errors?.length) {
            return { ok: false, reason: "graphql_error" };
          }

          // User not found => data.User === null
          const exists = !!json?.data?.User;
          return { ok: true, exists };
        } catch (e) {
          console.error("AniList check failed", e);
          return { ok: false, reason: "network" };
        }
      }

      // ========= UI render =========
      let settings = loadSettings();
      let draft = structuredClone(settings);

      function renderSummary() {
        const s = loadSettings();
        const users = s.anilistUsernames.length
          ? s.anilistUsernames.join(", ")
          : "(none)";
        const statuses = s.statuses.length ? s.statuses.join(", ") : "(none)";
        el("summary").innerHTML = `
          <div class="chip">Users: ${escapeHtml(users)}</div>
          <div class="chip">Combine: ${escapeHtml(s.combine)}</div>
          <div class="chip">Statuses: ${escapeHtml(statuses)}</div>
        `;
      }

      function renderModal() {
        // combine
        el("valCombine").textContent = draft.combine;
        for (const r of document.querySelectorAll('input[name="combine"]')) {
          r.checked = r.value === draft.combine;
        }

        // statuses
        const selected = new Set(draft.statuses || []);
        for (const cb of statusCheckboxes()) {
          cb.checked = selected.has(cb.value);
        }
        el("valStatuses").textContent = draft.statuses.length
          ? draft.statuses.join(", ")
          : "(none)";

        // users
        const list = el("userList");
        list.innerHTML = "";
        if (!draft.anilistUsernames.length) {
          const div = document.createElement("div");
          div.className = "user-item";
          div.innerHTML = `<div class="name" style="color: var(--muted)">(no users)</div>`;
          list.appendChild(div);
        } else {
          draft.anilistUsernames.forEach((u, idx) => {
            const row = document.createElement("div");
            row.className = "user-item";
            row.innerHTML = `
              <div class="name">${escapeHtml(u)}</div>
              <div class="meta">#${idx + 1}</div>
              <button class="mini-btn danger" data-del="${idx}">Remove</button>
            `;
            list.appendChild(row);
          });
        }
      }

      function statusCheckboxes() {
        return Array.from(
          el("backdrop").querySelectorAll('input[type="checkbox"][value]'),
        );
      }

      // ========= modal open/close =========
      const backdrop = el("backdrop");
      const openModal = () => {
        settings = loadSettings();
        draft = structuredClone(settings);
        renderModal();
        backdrop.classList.add("open");
        backdrop.setAttribute("aria-hidden", "false");
        el("inpUser").value = "";
        setToast("", "info");
      };
      const closeModal = () => {
        backdrop.classList.remove("open");
        backdrop.setAttribute("aria-hidden", "true");
        setToast("", "info");
      };

      el("btnSettings").addEventListener("click", openModal);
      el("closeBtn").addEventListener("click", closeModal);
      el("btnCancel").addEventListener("click", closeModal);
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeModal();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      // ========= start / reset =========
      el("btnStart").addEventListener("click", () => {
        location.href = "game.html";
      });

      el("btnReset").addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        renderSummary();
        setToast("Settings were reset.", "ok");
      });

      // ========= Loading state for Add User =========
      function setAddUserLoading(isLoading) {
        const btn = el("btnAddUser");
        const spin = el("spinAddUser");
        const lbl = el("lblAddUser");
        btn.disabled = isLoading;
        spin.classList.toggle("show", isLoading);
        lbl.textContent = isLoading ? "Checking…" : "Add";
      }

      // ========= modal interactions =========
      // add user
      async function addUserFromInput() {
        const input = el("inpUser");
        const raw = input.value;
        const name = normalizeUserName(raw);

        if (!name) {
          setToast("Please enter a username.", "warn");
          input.focus();
          return;
        }

        if (draft.anilistUsernames.includes(name)) {
          setToast("That user is already in the list.", "warn");
          input.value = "";
          input.focus();
          return;
        }

        setAddUserLoading(true);
        setToast("Checking if the user exists on AniList…", "info", 999999);

        try {
          const res = await anilistUserExists(name);

          if (!res.ok) {
            if (res.reason === "rate_limit") {
              setToast(
                "AniList is rate-limiting requests right now. Please wait a bit and try again.",
                "warn",
                5000,
              );
              return;
            }
            if (res.reason === "network") {
              setToast(
                "Network error. Please check your connection and try again.",
                "err",
                5000,
              );
              return;
            }
            setToast(
              "AniList check failed. Please try again in a moment.",
              "err",
              5000,
            );
            return;
          }

          if (!res.exists) {
            setToast(
              "User not found. Please double-check the spelling and try again.",
              "warn",
              5000,
            );
            input.focus();
            input.select?.();
            return;
          }

          draft.anilistUsernames = [...draft.anilistUsernames, name];
          input.value = "";
          renderModal();
          setToast("User added.", "ok");
        } finally {
          setAddUserLoading(false);
        }
      }

      el("btnAddUser").addEventListener("click", addUserFromInput);
      el("inpUser").addEventListener("keydown", (e) => {
        if (e.key === "Enter") addUserFromInput();
      });

      // remove user (event delegation)
      el("userList").addEventListener("click", (e) => {
        const btn = e.target.closest("[data-del]");
        if (!btn) return;
        const idx = Number(btn.getAttribute("data-del"));
        if (!Number.isFinite(idx)) return;
        draft.anilistUsernames.splice(idx, 1);
        renderModal();
        setToast("User removed.", "ok");
      });

      // combine
      for (const r of document.querySelectorAll('input[name="combine"]')) {
        r.addEventListener("change", () => {
          if (r.checked) {
            draft.combine = r.value;
            renderModal();
          }
        });
      }

      // statuses
      for (const cb of statusCheckboxes()) {
        cb.addEventListener("change", () => {
          const cur = new Set(draft.statuses);
          if (cb.checked) cur.add(cb.value);
          else cur.delete(cb.value);
          draft.statuses = Array.from(cur);
          renderModal();
        });
      }

      // save
      el("btnSave").addEventListener("click", () => {
        const picked = document.querySelector(
          'input[name="combine"]:checked',
        )?.value;
        if (picked === "OR" || picked === "AND") draft.combine = picked;

        // basic validation
        draft.anilistUsernames = uniq(
          draft.anilistUsernames.map(normalizeUserName),
        ).filter(Boolean);

        if (!draft.statuses.length) {
          setToast("Please select at least one status.", "warn", 5000);
          return;
        }

        saveSettings(draft);
        renderSummary();
        setToast("Saved.", "ok");
        closeModal();
      });

      // ========= init =========
      if (!localStorage.getItem(STORAGE_KEY)) saveSettings(defaultSettings());
      renderSummary();
    </script>
  </body>
</html>
